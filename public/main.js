'use strict';

var angApp = angular.module('main', ['ui.router']);

angApp.config(function ($urlRouterProvider) {
	$urlRouterProvider.otherwise('/');
});

angApp.controller('DashboardCtrl', function ($rootScope, $scope, Storage, initialize) {
	//code
	$rootScope.$on('dbLoaded', function () {
		console.log('initialized', Storage.findOrCreate('Rick and Morty').then(function (result) {
			return console.log(result);
		}));
		// .then(function(result) {console.log(result)});
	});
});

angApp.config(function ($stateProvider) {
	$stateProvider.state('dashboardState', {
		url: '/test',
		templateUrl: './app/js/dashboard/dashboard.html'
	});
});

angApp.controller('ExplorerCtrl', function ($scope, $element, vidConstants) {
	// Code to make the 'file holder div' take in
	// file path names
	var homedir = process.platform === 'win32' ? process.env.HOMEPATH : process.env.HOME;
	var shell = require('electron').shell;
	// var finder = require('./server/algorithms/search.js')
	var fs = require('fs');
	var path = require('path');
	var find = require('findit');
	var parseVideo = require('video-name-parser');

	//Button called "browse", opens homedirectory of user
	$scope.openHome = function () {
		return shell.showItemInFolder(homedir);
	};

	// --------------------------
	// Code that allows you to recurse through the directories
	//provided and return file names that end with certain exts

	var holder = document.getElementById('fileholder');
	holder.ondragover = function () {
		this.className = 'hover';
		return false;
	};
	holder.ondragleave = function () {
		this.className = '';
		return false;
	};
	holder.ondrop = function (e) {
		var dataPathArray = [];
		var soln = [];
		e.preventDefault();
		for (var i = 0; i < e.dataTransfer.files.length; ++i) {
			dataPathArray.push(e.dataTransfer.files[i].path);
		}
		dataPathArray.forEach(function (data) {
			var finder = find(data);
			finder.on('file', function (file, stat) {
				if (vidConstants.vidExtensions.indexOf(path.extname(file)) !== -1) {
					var parsed = parseVideo(file);
					soln.push(parsed);
				}
				console.log("Thank you for your patience!");
			});
			finder.on('end', function (file, stat) {
				// soln.forEach()
				console.log('soln', soln);
			});
		});
		return false;
	};
});

angApp.factory('vidConstants', function () {
	return {
		vidExtensions: ['.mkv', '.avi', '.mov', '.gifv', '.flv']
	};
});

angApp.config(function ($stateProvider) {
	$stateProvider.state('explorerState', {
		url: '/',
		templateUrl: './app/js/explorer/explorer.html',
		controller: 'ExplorerCtrl'
	});
});

'use strict';
var loki = require('lokijs'),
    path = require('path'),
    Promise = require('bluebird'),
    omdb = Promise.promisifyAll(require('omdb'));

angApp.factory('Storage', function ($rootScope) {
	function findOmdb(name) {
		console.log('in omdb function', name);
		return omdb.searchAsync(name).then(function (results) {
			if (results.length < 1) return;
			if (results.length >= 1) {
				return omdb.getAsync(results[0].imdb);
			}
		});
	};
	//Not being used anymore
	function addMedia(mediaTitle) {
		var self = this;
		console.log(self);
		return new Promise(function (resolve, reject) {
			console.log(self);
			findOmdb(mediaTitle).then(function (metadata) {
				var media = {};
				media = metadata;
				media._id = metadata.imdb.id;
				self.collection.insert(media);
				console.log(media);
				self.db.saveDatabase();
			}).then(function () {
				resolve(self);
			}, function (err) {
				reject(err);
			});
		});
	};

	return {
		db: new loki(path.resolve(__dirname, 'app.db')),
		collection: null,
		loaded: false,
		init: function init() {
			var self = this;
			self.db.loadDatabase({}, function () {
				return new Promise(function (resolve, reject) {
					if (self.db.collections.length) {
						self.collection = self.db.getCollection('media');
						self.loaded = true;
						return resolve(self);
					} else {
						self.db.addCollection('media');
						self.db.saveDatabase();
						self.collection = self.db.getCollection('media');
						self.loaded = true;
						return resolve(self);
					}
				}).then(function () {
					console.log('in the factory', self);
					$rootScope.$emit('dbLoaded');
				}).then(null, function (err) {
					console.log(err);
				});
				// .catch(function(err) {
				// 	console.log(err);
				// })
			});
		},
		findMedia: function findMedia(mediaId) {
			var self = this;
			return new Promise(function (resolve, reject) {
				if (self.loaded && self.db.getCollection('media')) {
					return resolve(self.collection.find({
						"_id": mediaId
					}));
				} else {
					reject(new Error('db is not ready'));
				}
			});
		},
		//not being used either
		addMedia: addMedia,
		findOrCreate: function findOrCreate(mediaTitle, seasons) {
			var self = this;
			console.log('in the findOrCreate');
			return new Promise(function (resolve, reject) {
				if (self.loaded && self.db.getCollection('media')) {
					findOmdb(mediaTitle).then(function (metadata) {
						if (self.collection.find({
							'_id': metadata.imdb.id
						}).length > 0) {
							console.log(self.collection.find({
								'title': mediaTitle
							}).length);
							//Still need to return actual file
							return resolve(null);
						} else {
							console.log('creating');
							var media = {};
							media = metadata;
							media._id = metadata.imdb.id;
							media.seasons = seasons;
							self.collection.insert(media);
							console.log(media);
							self.db.saveDatabase();
							resolve(self);
						}
					});
				} else {
					reject(new Error('db is not ready'));
				}
			});
		},
		updateTimestamp: function updateTimestamp(mediaTitle, season, episode, newTimestamp) {
			return new Promise(function (resolve, reject) {
				if (self.loaded && self.db.getCollection('media')) {
					findOmdb(mediaTitle).then(function (metadata) {
						if (self.collection.find({
							'_id': metadata.imdb.id
						})) {
							var updating = self.collection.findOne({
								'_id': metadata.imdb.id
							});
							updating.seasons[season][episode].timestamp = newTimestamp;
							resolve(self.collection.update(updating));
						} else {
							reject(new Error('media not found'));
						}
					});
				}
			});
		}
	};
});

angApp.controller('SidebarCtrl', function ($scope) {

	//Leftover attempts to make sidebar toggleable
	// $scope.menuActive = false;
	// var wrapper = document.getElementById('sidebar-wrapper')
	// $scope.toggleMenu = function(e) {
	//   // wrapper.toggleClass("toggled");
	//   $scope.menuActive = !$scope.menuActive;
	//}

	//placeholder for making new playlists

});

angApp.directive('sidebar', function () {
	return {
		restrict: 'E',
		templateUrl: './app/js/directives/sidebar/sidebar.html'
	};
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImpzL2Rhc2hib2FyZC9kYXNoYm9hcmQuY29udHJvbGxlci5qcyIsImpzL2Rhc2hib2FyZC9kYXNoYm9hcmQuc3RhdGUuanMiLCJqcy9leHBsb3Jlci9leHBsb3Jlci5jb250cm9sbGVyLmpzIiwianMvZXhwbG9yZXIvZXhwbG9yZXIuc3RhdGUuanMiLCJqcy9jb21tb24vZmFjdG9yaWVzL0NhY2hlRmFjdG9yeS5qcyIsImpzL2RpcmVjdGl2ZXMvc2lkZWJhci9zaWRlYmFyLmNvbnRyb2xsZXIuanMiLCJqcy9kaXJlY3RpdmVzL3NpZGViYXIvc2lkZWJhci5kaXJlY3RpdmUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFBLE1BQUEsR0FBQSxPQUFBLENBQUEsTUFBQSxDQUFBLE1BQUEsRUFBQSxDQUFBLFdBQUEsQ0FBQSxDQUFBLENBQUE7O0FBRUEsTUFBQSxDQUFBLE1BQUEsQ0FBQSxVQUFBLGtCQUFBLEVBQUE7QUFDQSxtQkFBQSxDQUFBLFNBQUEsQ0FBQSxHQUFBLENBQUEsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUNKQSxNQUFBLENBQUEsVUFBQSxDQUFBLGVBQUEsRUFBQSxVQUFBLFVBQUEsRUFBQSxNQUFBLEVBQUEsT0FBQSxFQUFBLFVBQUEsRUFBQTs7QUFFQSxXQUFBLENBQUEsR0FBQSxDQUFBLFVBQUEsRUFBQSxZQUFBO0FBQ0EsU0FBQSxDQUFBLEdBQUEsQ0FBQSxhQUFBLEVBQUEsT0FBQSxDQUFBLFlBQUEsQ0FBQSxnQkFBQSxDQUFBLENBQUEsSUFBQSxDQUFBLFVBQUEsTUFBQTtVQUFBLE9BQUEsQ0FBQSxHQUFBLENBQUEsTUFBQSxDQUFBO0dBQUEsQ0FBQSxDQUFBLENBQUE7O0VBRUEsQ0FBQSxDQUFBO0NBRUEsQ0FBQSxDQUFBOztBQ1BBLE1BQUEsQ0FBQSxNQUFBLENBQUEsVUFBQSxjQUFBLEVBQUE7QUFDQSxlQUFBLENBQUEsS0FBQSxDQUFBLGdCQUFBLEVBQUE7QUFDQSxLQUFBLEVBQUEsT0FBQTtBQUNBLGFBQUEsRUFBQSxtQ0FBQTtFQUNBLENBQUEsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUNMQSxNQUFBLENBQUEsVUFBQSxDQUFBLGNBQUEsRUFBQSxVQUFBLE1BQUEsRUFBQSxRQUFBLEVBQUEsWUFBQSxFQUFBOzs7QUFHQSxLQUFBLE9BQUEsR0FBQSxPQUFBLENBQUEsUUFBQSxLQUFBLE9BQUEsR0FBQSxPQUFBLENBQUEsR0FBQSxDQUFBLFFBQUEsR0FDQSxPQUFBLENBQUEsR0FBQSxDQUFBLElBQUEsQ0FBQTtBQUNBLEtBQUEsS0FBQSxHQUFBLE9BQUEsQ0FBQSxVQUFBLENBQUEsQ0FBQSxLQUFBLENBQUE7O0FBRUEsS0FBQSxFQUFBLEdBQUEsT0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBO0FBQ0EsS0FBQSxJQUFBLEdBQUEsT0FBQSxDQUFBLE1BQUEsQ0FBQSxDQUFBO0FBQ0EsS0FBQSxJQUFBLEdBQUEsT0FBQSxDQUFBLFFBQUEsQ0FBQSxDQUFBO0FBQ0EsS0FBQSxVQUFBLEdBQUEsT0FBQSxDQUFBLG1CQUFBLENBQUEsQ0FBQTs7O0FBR0EsT0FBQSxDQUFBLFFBQUEsR0FBQSxZQUFBO0FBQ0EsU0FBQSxLQUFBLENBQUEsZ0JBQUEsQ0FBQSxPQUFBLENBQUEsQ0FBQTtFQUNBLENBQUE7Ozs7OztBQU1BLEtBQUEsTUFBQSxHQUFBLFFBQUEsQ0FBQSxjQUFBLENBQUEsWUFBQSxDQUFBLENBQUE7QUFDQSxPQUFBLENBQUEsVUFBQSxHQUFBLFlBQUE7QUFDQSxNQUFBLENBQUEsU0FBQSxHQUFBLE9BQUEsQ0FBQTtBQUNBLFNBQUEsS0FBQSxDQUFBO0VBQ0EsQ0FBQTtBQUNBLE9BQUEsQ0FBQSxXQUFBLEdBQUEsWUFBQTtBQUNBLE1BQUEsQ0FBQSxTQUFBLEdBQUEsRUFBQSxDQUFBO0FBQ0EsU0FBQSxLQUFBLENBQUE7RUFDQSxDQUFBO0FBQ0EsT0FBQSxDQUFBLE1BQUEsR0FBQSxVQUFBLENBQUEsRUFBQTtBQUNBLE1BQUEsYUFBQSxHQUFBLEVBQUEsQ0FBQTtBQUNBLE1BQUEsSUFBQSxHQUFBLEVBQUEsQ0FBQTtBQUNBLEdBQUEsQ0FBQSxjQUFBLEVBQUEsQ0FBQTtBQUNBLE9BQUEsSUFBQSxDQUFBLEdBQUEsQ0FBQSxFQUFBLENBQUEsR0FBQSxDQUFBLENBQUEsWUFBQSxDQUFBLEtBQUEsQ0FBQSxNQUFBLEVBQUEsRUFBQSxDQUFBLEVBQUE7QUFDQSxnQkFBQSxDQUFBLElBQUEsQ0FBQSxDQUFBLENBQUEsWUFBQSxDQUFBLEtBQUEsQ0FBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQTtHQUNBO0FBQ0EsZUFBQSxDQUFBLE9BQUEsQ0FBQSxVQUFBLElBQUEsRUFBQTtBQUNBLE9BQUEsTUFBQSxHQUFBLElBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQTtBQUNBLFNBQUEsQ0FBQSxFQUFBLENBQUEsTUFBQSxFQUFBLFVBQUEsSUFBQSxFQUFBLElBQUEsRUFBQTtBQUNBLFFBQUEsWUFBQSxDQUFBLGFBQUEsQ0FBQSxPQUFBLENBQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQSxLQUNBLENBQUEsQ0FBQSxFQUFBO0FBQ0EsU0FBQSxNQUFBLEdBQUEsVUFBQSxDQUFBLElBQUEsQ0FBQSxDQUFBO0FBQ0EsU0FBQSxDQUFBLElBQUEsQ0FBQSxNQUFBLENBQUEsQ0FBQTtLQUNBO0FBQ0EsV0FBQSxDQUFBLEdBQUEsQ0FBQSw4QkFBQSxDQUFBLENBQUE7SUFDQSxDQUFBLENBQUE7QUFDQSxTQUFBLENBQUEsRUFBQSxDQUFBLEtBQUEsRUFBQSxVQUFBLElBQUEsRUFBQSxJQUFBLEVBQUE7O0FBRUEsV0FBQSxDQUFBLEdBQUEsQ0FBQSxNQUFBLEVBQUEsSUFBQSxDQUFBLENBQUE7SUFDQSxDQUFBLENBQUE7R0FDQSxDQUFBLENBQUE7QUFDQSxTQUFBLEtBQUEsQ0FBQTtFQUNBLENBQUE7Q0FDQSxDQUFBLENBQUE7O0FBR0EsTUFBQSxDQUFBLE9BQUEsQ0FBQSxjQUFBLEVBQUEsWUFBQTtBQUNBLFFBQUE7QUFDQSxlQUFBLEVBQUEsQ0FBQSxNQUFBLEVBQUEsTUFBQSxFQUFBLE1BQUEsRUFBQSxPQUFBLEVBQUEsTUFBQSxDQUFBO0VBQ0EsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUM3REEsTUFBQSxDQUFBLE1BQUEsQ0FBQSxVQUFBLGNBQUEsRUFBQTtBQUNBLGVBQUEsQ0FBQSxLQUFBLENBQUEsZUFBQSxFQUFBO0FBQ0EsS0FBQSxFQUFBLEdBQUE7QUFDQSxhQUFBLEVBQUEsaUNBQUE7QUFDQSxZQUFBLEVBQUEsY0FBQTtFQUNBLENBQUEsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUNOQSxZQUFBLENBQUE7QUFDQSxJQUFBLElBQUEsR0FBQSxPQUFBLENBQUEsUUFBQSxDQUFBO0lBQ0EsSUFBQSxHQUFBLE9BQUEsQ0FBQSxNQUFBLENBQUE7SUFDQSxPQUFBLEdBQUEsT0FBQSxDQUFBLFVBQUEsQ0FBQTtJQUNBLElBQUEsR0FBQSxPQUFBLENBQUEsWUFBQSxDQUFBLE9BQUEsQ0FBQSxNQUFBLENBQUEsQ0FBQSxDQUFBOztBQUdBLE1BQUEsQ0FBQSxPQUFBLENBQUEsU0FBQSxFQUFBLFVBQUEsVUFBQSxFQUFBO0FBQ0EsVUFBQSxRQUFBLENBQUEsSUFBQSxFQUFBO0FBQ0EsU0FBQSxDQUFBLEdBQUEsQ0FBQSxrQkFBQSxFQUFBLElBQUEsQ0FBQSxDQUFBO0FBQ0EsU0FBQSxJQUFBLENBQUEsV0FBQSxDQUFBLElBQUEsQ0FBQSxDQUNBLElBQUEsQ0FBQSxVQUFBLE9BQUEsRUFBQTtBQUNBLE9BQUEsT0FBQSxDQUFBLE1BQUEsR0FBQSxDQUFBLEVBQUEsT0FBQTtBQUNBLE9BQUEsT0FBQSxDQUFBLE1BQUEsSUFBQSxDQUFBLEVBQUE7QUFDQSxXQUFBLElBQUEsQ0FBQSxRQUFBLENBQUEsT0FBQSxDQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBO0lBQ0E7R0FDQSxDQUFBLENBQUE7RUFDQSxDQUFBOztBQUVBLFVBQUEsUUFBQSxDQUFBLFVBQUEsRUFBQTtBQUNBLE1BQUEsSUFBQSxHQUFBLElBQUEsQ0FBQTtBQUNBLFNBQUEsQ0FBQSxHQUFBLENBQUEsSUFBQSxDQUFBLENBQUE7QUFDQSxTQUFBLElBQUEsT0FBQSxDQUFBLFVBQUEsT0FBQSxFQUFBLE1BQUEsRUFBQTtBQUNBLFVBQUEsQ0FBQSxHQUFBLENBQUEsSUFBQSxDQUFBLENBQUE7QUFDQSxXQUFBLENBQUEsVUFBQSxDQUFBLENBQ0EsSUFBQSxDQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsUUFBQSxLQUFBLEdBQUEsRUFBQSxDQUFBO0FBQ0EsU0FBQSxHQUFBLFFBQUEsQ0FBQTtBQUNBLFNBQUEsQ0FBQSxHQUFBLEdBQUEsUUFBQSxDQUFBLElBQUEsQ0FBQSxFQUFBLENBQUE7QUFDQSxRQUFBLENBQUEsVUFBQSxDQUFBLE1BQUEsQ0FBQSxLQUFBLENBQUEsQ0FBQTtBQUNBLFdBQUEsQ0FBQSxHQUFBLENBQUEsS0FBQSxDQUFBLENBQUE7QUFDQSxRQUFBLENBQUEsRUFBQSxDQUFBLFlBQUEsRUFBQSxDQUFBO0lBQ0EsQ0FBQSxDQUNBLElBQUEsQ0FBQSxZQUFBO0FBQ0EsV0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBO0lBQ0EsRUFBQSxVQUFBLEdBQUEsRUFBQTtBQUNBLFVBQUEsQ0FBQSxHQUFBLENBQUEsQ0FBQTtJQUNBLENBQUEsQ0FBQTtHQUNBLENBQUEsQ0FBQTtFQUNBLENBQUE7O0FBRUEsUUFBQTtBQUNBLElBQUEsRUFBQSxJQUFBLElBQUEsQ0FBQSxJQUFBLENBQUEsT0FBQSxDQUFBLFNBQUEsRUFBQSxRQUFBLENBQUEsQ0FBQTtBQUNBLFlBQUEsRUFBQSxJQUFBO0FBQ0EsUUFBQSxFQUFBLEtBQUE7QUFDQSxNQUFBLEVBQUEsZ0JBQUE7QUFDQSxPQUFBLElBQUEsR0FBQSxJQUFBLENBQUE7QUFDQSxPQUFBLENBQUEsRUFBQSxDQUFBLFlBQUEsQ0FBQSxFQUFBLEVBQUEsWUFBQTtBQUNBLFdBQUEsSUFBQSxPQUFBLENBQUEsVUFBQSxPQUFBLEVBQUEsTUFBQSxFQUFBO0FBQ0EsU0FBQSxJQUFBLENBQUEsRUFBQSxDQUFBLFdBQUEsQ0FBQSxNQUFBLEVBQUE7QUFDQSxVQUFBLENBQUEsVUFBQSxHQUFBLElBQUEsQ0FBQSxFQUFBLENBQUEsYUFBQSxDQUFBLE9BQUEsQ0FBQSxDQUFBO0FBQ0EsVUFBQSxDQUFBLE1BQUEsR0FBQSxJQUFBLENBQUE7QUFDQSxhQUFBLE9BQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQTtNQUNBLE1BQUE7QUFDQSxVQUFBLENBQUEsRUFBQSxDQUFBLGFBQUEsQ0FBQSxPQUFBLENBQUEsQ0FBQTtBQUNBLFVBQUEsQ0FBQSxFQUFBLENBQUEsWUFBQSxFQUFBLENBQUE7QUFDQSxVQUFBLENBQUEsVUFBQSxHQUFBLElBQUEsQ0FBQSxFQUFBLENBQUEsYUFBQSxDQUFBLE9BQUEsQ0FBQSxDQUFBO0FBQ0EsVUFBQSxDQUFBLE1BQUEsR0FBQSxJQUFBLENBQUE7QUFDQSxhQUFBLE9BQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQTtNQUNBO0tBQ0EsQ0FBQSxDQUNBLElBQUEsQ0FBQSxZQUFBO0FBQ0EsWUFBQSxDQUFBLEdBQUEsQ0FBQSxnQkFBQSxFQUFBLElBQUEsQ0FBQSxDQUFBO0FBQ0EsZUFBQSxDQUFBLEtBQUEsQ0FBQSxVQUFBLENBQUEsQ0FBQTtLQUNBLENBQUEsQ0FDQSxJQUFBLENBQUEsSUFBQSxFQUFBLFVBQUEsR0FBQSxFQUFBO0FBQ0EsWUFBQSxDQUFBLEdBQUEsQ0FBQSxHQUFBLENBQUEsQ0FBQTtLQUNBLENBQUEsQ0FBQTs7OztJQUlBLENBQUEsQ0FBQTtHQUNBO0FBQ0EsV0FBQSxFQUFBLG1CQUFBLE9BQUEsRUFBQTtBQUNBLE9BQUEsSUFBQSxHQUFBLElBQUEsQ0FBQTtBQUNBLFVBQUEsSUFBQSxPQUFBLENBQUEsVUFBQSxPQUFBLEVBQUEsTUFBQSxFQUFBO0FBQ0EsUUFBQSxJQUFBLENBQUEsTUFBQSxJQUFBLElBQUEsQ0FBQSxFQUFBLENBQUEsYUFBQSxDQUFBLE9BQUEsQ0FBQSxFQUFBO0FBQ0EsWUFBQSxPQUFBLENBQUEsSUFBQSxDQUFBLFVBQUEsQ0FBQSxJQUFBLENBQUE7QUFDQSxXQUFBLEVBQUEsT0FBQTtNQUNBLENBQUEsQ0FBQSxDQUFBO0tBQ0EsTUFBQTtBQUNBLFdBQUEsQ0FBQSxJQUFBLEtBQUEsQ0FBQSxpQkFBQSxDQUFBLENBQUEsQ0FBQTtLQUNBO0lBQ0EsQ0FBQSxDQUFBO0dBQ0E7O0FBRUEsVUFBQSxFQUFBLFFBQUE7QUFDQSxjQUFBLEVBQUEsc0JBQUEsVUFBQSxFQUFBLE9BQUEsRUFBQTtBQUNBLE9BQUEsSUFBQSxHQUFBLElBQUEsQ0FBQTtBQUNBLFVBQUEsQ0FBQSxHQUFBLENBQUEscUJBQUEsQ0FBQSxDQUFBO0FBQ0EsVUFBQSxJQUFBLE9BQUEsQ0FBQSxVQUFBLE9BQUEsRUFBQSxNQUFBLEVBQUE7QUFDQSxRQUFBLElBQUEsQ0FBQSxNQUFBLElBQUEsSUFBQSxDQUFBLEVBQUEsQ0FBQSxhQUFBLENBQUEsT0FBQSxDQUFBLEVBQUE7QUFDQSxhQUFBLENBQUEsVUFBQSxDQUFBLENBQ0EsSUFBQSxDQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsVUFBQSxJQUFBLENBQUEsVUFBQSxDQUFBLElBQUEsQ0FBQTtBQUNBLFlBQUEsRUFBQSxRQUFBLENBQUEsSUFBQSxDQUFBLEVBQUE7T0FDQSxDQUFBLENBQUEsTUFBQSxHQUFBLENBQUEsRUFBQTtBQUNBLGNBQUEsQ0FBQSxHQUFBLENBQUEsSUFBQSxDQUFBLFVBQUEsQ0FBQSxJQUFBLENBQUE7QUFDQSxlQUFBLEVBQUEsVUFBQTtRQUNBLENBQUEsQ0FBQSxNQUFBLENBQUEsQ0FBQTs7QUFFQSxjQUFBLE9BQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQTtPQUNBLE1BQUE7QUFDQSxjQUFBLENBQUEsR0FBQSxDQUFBLFVBQUEsQ0FBQSxDQUFBO0FBQ0EsV0FBQSxLQUFBLEdBQUEsRUFBQSxDQUFBO0FBQ0EsWUFBQSxHQUFBLFFBQUEsQ0FBQTtBQUNBLFlBQUEsQ0FBQSxHQUFBLEdBQUEsUUFBQSxDQUFBLElBQUEsQ0FBQSxFQUFBLENBQUE7QUFDQSxZQUFBLENBQUEsT0FBQSxHQUFBLE9BQUEsQ0FBQTtBQUNBLFdBQUEsQ0FBQSxVQUFBLENBQUEsTUFBQSxDQUFBLEtBQUEsQ0FBQSxDQUFBO0FBQ0EsY0FBQSxDQUFBLEdBQUEsQ0FBQSxLQUFBLENBQUEsQ0FBQTtBQUNBLFdBQUEsQ0FBQSxFQUFBLENBQUEsWUFBQSxFQUFBLENBQUE7QUFDQSxjQUFBLENBQUEsSUFBQSxDQUFBLENBQUE7T0FDQTtNQUNBLENBQUEsQ0FBQTtLQUNBLE1BQUE7QUFDQSxXQUFBLENBQUEsSUFBQSxLQUFBLENBQUEsaUJBQUEsQ0FBQSxDQUFBLENBQUE7S0FDQTtJQUNBLENBQUEsQ0FBQTtHQUNBO0FBQ0EsaUJBQUEsRUFBQSx5QkFBQSxVQUFBLEVBQUEsTUFBQSxFQUFBLE9BQUEsRUFBQSxZQUFBLEVBQUE7QUFDQSxVQUFBLElBQUEsT0FBQSxDQUFBLFVBQUEsT0FBQSxFQUFBLE1BQUEsRUFBQTtBQUNBLFFBQUEsSUFBQSxDQUFBLE1BQUEsSUFBQSxJQUFBLENBQUEsRUFBQSxDQUFBLGFBQUEsQ0FBQSxPQUFBLENBQUEsRUFBQTtBQUNBLGFBQUEsQ0FBQSxVQUFBLENBQUEsQ0FDQSxJQUFBLENBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxVQUFBLElBQUEsQ0FBQSxVQUFBLENBQUEsSUFBQSxDQUFBO0FBQ0EsWUFBQSxFQUFBLFFBQUEsQ0FBQSxJQUFBLENBQUEsRUFBQTtPQUNBLENBQUEsRUFBQTtBQUNBLFdBQUEsUUFBQSxHQUFBLElBQUEsQ0FBQSxVQUFBLENBQUEsT0FBQSxDQUFBO0FBQ0EsYUFBQSxFQUFBLFFBQUEsQ0FBQSxJQUFBLENBQUEsRUFBQTtRQUNBLENBQUEsQ0FBQTtBQUNBLGVBQUEsQ0FBQSxPQUFBLENBQUEsTUFBQSxDQUFBLENBQUEsT0FBQSxDQUFBLENBQUEsU0FBQSxHQUFBLFlBQUEsQ0FBQTtBQUNBLGNBQUEsQ0FBQSxJQUFBLENBQUEsVUFBQSxDQUFBLE1BQUEsQ0FBQSxRQUFBLENBQUEsQ0FBQSxDQUFBO09BQ0EsTUFBQTtBQUNBLGFBQUEsQ0FBQSxJQUFBLEtBQUEsQ0FBQSxpQkFBQSxDQUFBLENBQUEsQ0FBQTtPQUNBO01BQ0EsQ0FBQSxDQUFBO0tBQ0E7SUFDQSxDQUFBLENBQUE7R0FDQTtFQUNBLENBQUE7Q0FDQSxDQUFBLENBQUE7O0FDNUlBLE1BQUEsQ0FBQSxVQUFBLENBQUEsYUFBQSxFQUFBLFVBQUEsTUFBQSxFQUFBOzs7Ozs7Ozs7Ozs7Q0FhQSxDQUFBLENBQUE7O0FDYkEsTUFBQSxDQUFBLFNBQUEsQ0FBQSxTQUFBLEVBQUEsWUFBQTtBQUNBLFFBQUE7QUFDQSxVQUFBLEVBQUEsR0FBQTtBQUNBLGFBQUEsRUFBQSwwQ0FBQTtFQUNBLENBQUE7Q0FDQSxDQUFBLENBQUEiLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBhbmdBcHAgPSBhbmd1bGFyLm1vZHVsZSgnbWFpbicsIFsndWkucm91dGVyJ10pO1xuXG5hbmdBcHAuY29uZmlnKGZ1bmN0aW9uKCR1cmxSb3V0ZXJQcm92aWRlcikge1xuICAkdXJsUm91dGVyUHJvdmlkZXIub3RoZXJ3aXNlKCcvJyk7XG59KVxuIiwiYW5nQXBwLmNvbnRyb2xsZXIoJ0Rhc2hib2FyZEN0cmwnLCBmdW5jdGlvbigkcm9vdFNjb3BlLCAkc2NvcGUsIFN0b3JhZ2UsIGluaXRpYWxpemUpe1xuICAvL2NvZGVcbiAgJHJvb3RTY29wZS4kb24oJ2RiTG9hZGVkJywgZnVuY3Rpb24oKSB7XG4gICAgY29uc29sZS5sb2coJ2luaXRpYWxpemVkJywgU3RvcmFnZS5maW5kT3JDcmVhdGUoJ1JpY2sgYW5kIE1vcnR5JykudGhlbihyZXN1bHQ9PiBjb25zb2xlLmxvZyhyZXN1bHQpKSk7XG4gICAgLy8gLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7Y29uc29sZS5sb2cocmVzdWx0KX0pO1xuICB9KVxuXG59KVxuIiwiYW5nQXBwLmNvbmZpZyhmdW5jdGlvbigkc3RhdGVQcm92aWRlcikge1xuICAkc3RhdGVQcm92aWRlci5zdGF0ZSgnZGFzaGJvYXJkU3RhdGUnLCB7XG4gICAgdXJsOiAnL3Rlc3QnLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9hcHAvanMvZGFzaGJvYXJkL2Rhc2hib2FyZC5odG1sJ1xuICB9KVxufSlcbiIsImFuZ0FwcC5jb250cm9sbGVyKCdFeHBsb3JlckN0cmwnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCB2aWRDb25zdGFudHMpIHtcbiAgLy8gQ29kZSB0byBtYWtlIHRoZSAnZmlsZSBob2xkZXIgZGl2JyB0YWtlIGluXG4gIC8vIGZpbGUgcGF0aCBuYW1lc1xuICB2YXIgaG9tZWRpciA9IChwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInKSA/IHByb2Nlc3MuZW52LkhPTUVQQVRIIDpcbiAgICBwcm9jZXNzLmVudi5IT01FO1xuICBjb25zdCBzaGVsbCA9IHJlcXVpcmUoJ2VsZWN0cm9uJykuc2hlbGw7XG4gIC8vIHZhciBmaW5kZXIgPSByZXF1aXJlKCcuL3NlcnZlci9hbGdvcml0aG1zL3NlYXJjaC5qcycpXG4gIHZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG4gIHZhciBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuICB2YXIgZmluZCA9IHJlcXVpcmUoJ2ZpbmRpdCcpO1xuICB2YXIgcGFyc2VWaWRlbyA9IHJlcXVpcmUoJ3ZpZGVvLW5hbWUtcGFyc2VyJyk7XG5cbiAgLy9CdXR0b24gY2FsbGVkIFwiYnJvd3NlXCIsIG9wZW5zIGhvbWVkaXJlY3Rvcnkgb2YgdXNlclxuICAkc2NvcGUub3BlbkhvbWUgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gc2hlbGwuc2hvd0l0ZW1JbkZvbGRlcihob21lZGlyKTtcbiAgfVxuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIENvZGUgdGhhdCBhbGxvd3MgeW91IHRvIHJlY3Vyc2UgdGhyb3VnaCB0aGUgZGlyZWN0b3JpZXNcbiAgLy9wcm92aWRlZCBhbmQgcmV0dXJuIGZpbGUgbmFtZXMgdGhhdCBlbmQgd2l0aCBjZXJ0YWluIGV4dHNcblxuICB2YXIgaG9sZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbGVob2xkZXInKTtcbiAgaG9sZGVyLm9uZHJhZ292ZXIgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLmNsYXNzTmFtZSA9ICdob3Zlcic7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9O1xuICBob2xkZXIub25kcmFnbGVhdmUgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLmNsYXNzTmFtZSA9ICcnO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfTtcbiAgaG9sZGVyLm9uZHJvcCA9IGZ1bmN0aW9uKGUpIHtcbiAgICB2YXIgZGF0YVBhdGhBcnJheSA9IFtdO1xuICAgIHZhciBzb2xuID0gW107XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZS5kYXRhVHJhbnNmZXIuZmlsZXMubGVuZ3RoOyArK2kpIHtcbiAgICAgIGRhdGFQYXRoQXJyYXkucHVzaChlLmRhdGFUcmFuc2Zlci5maWxlc1tpXS5wYXRoKTtcbiAgICB9XG4gICAgZGF0YVBhdGhBcnJheS5mb3JFYWNoKGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgIHZhciBmaW5kZXIgPSBmaW5kKGRhdGEpO1xuICAgICAgZmluZGVyLm9uKCdmaWxlJywgZnVuY3Rpb24oZmlsZSwgc3RhdCkge1xuICAgICAgICBpZiAodmlkQ29uc3RhbnRzLnZpZEV4dGVuc2lvbnMuaW5kZXhPZihwYXRoLmV4dG5hbWUoZmlsZSkpICE9PVxuICAgICAgICAgIC0xKSB7XG4gICAgICAgICAgdmFyIHBhcnNlZCA9IHBhcnNlVmlkZW8oZmlsZSk7XG4gICAgICAgICAgc29sbi5wdXNoKHBhcnNlZCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc29sZS5sb2coXCJUaGFuayB5b3UgZm9yIHlvdXIgcGF0aWVuY2UhXCIpO1xuICAgICAgfSlcbiAgICAgIGZpbmRlci5vbignZW5kJywgZnVuY3Rpb24oZmlsZSwgc3RhdCkge1xuICAgICAgICAvLyBzb2xuLmZvckVhY2goKVxuICAgICAgICBjb25zb2xlLmxvZygnc29sbicsIHNvbG4pXG4gICAgICB9KVxuICAgIH0pXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9O1xufSk7XG5cblxuYW5nQXBwLmZhY3RvcnkoJ3ZpZENvbnN0YW50cycsIGZ1bmN0aW9uKCkge1xuICByZXR1cm4ge1xuICAgIHZpZEV4dGVuc2lvbnM6IFsnLm1rdicsICcuYXZpJywgJy5tb3YnLCAnLmdpZnYnLCAnLmZsdiddXG4gIH1cbn0pXG4iLCJhbmdBcHAuY29uZmlnKGZ1bmN0aW9uKCRzdGF0ZVByb3ZpZGVyKSB7XG4gICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCdleHBsb3JlclN0YXRlJywge1xuICAgIHVybDogJy8nLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9hcHAvanMvZXhwbG9yZXIvZXhwbG9yZXIuaHRtbCcsXG4gICAgY29udHJvbGxlcjogJ0V4cGxvcmVyQ3RybCdcbiAgfSlcbn0pXG4iLCIndXNlIHN0cmljdCc7XG52YXIgbG9raSA9IHJlcXVpcmUoJ2xva2lqcycpLFxuXHRwYXRoID0gcmVxdWlyZSgncGF0aCcpLFxuXHRQcm9taXNlID0gcmVxdWlyZSgnYmx1ZWJpcmQnKSxcblx0b21kYiA9IFByb21pc2UucHJvbWlzaWZ5QWxsKHJlcXVpcmUoJ29tZGInKSk7XG5cblxuYW5nQXBwLmZhY3RvcnkoJ1N0b3JhZ2UnLCBmdW5jdGlvbigkcm9vdFNjb3BlKSB7XG5cdGZ1bmN0aW9uIGZpbmRPbWRiKG5hbWUpIHtcblx0XHRjb25zb2xlLmxvZygnaW4gb21kYiBmdW5jdGlvbicsIG5hbWUpO1xuXHRcdHJldHVybiBvbWRiLnNlYXJjaEFzeW5jKG5hbWUpXG5cdFx0XHQudGhlbihmdW5jdGlvbihyZXN1bHRzKSB7XG5cdFx0XHRcdGlmIChyZXN1bHRzLmxlbmd0aCA8IDEpIHJldHVybjtcblx0XHRcdFx0aWYgKHJlc3VsdHMubGVuZ3RoID49IDEpIHtcblx0XHRcdFx0XHRyZXR1cm4gb21kYi5nZXRBc3luYyhyZXN1bHRzWzBdLmltZGIpO1xuXHRcdFx0XHR9XG5cdFx0XHR9KVxuXHR9O1xuXHQvL05vdCBiZWluZyB1c2VkIGFueW1vcmVcblx0ZnVuY3Rpb24gYWRkTWVkaWEobWVkaWFUaXRsZSkge1xuXHRcdHZhciBzZWxmID0gdGhpcztcblx0XHRjb25zb2xlLmxvZyhzZWxmKTtcblx0XHRyZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG5cdFx0XHRjb25zb2xlLmxvZyhzZWxmKTtcblx0XHRcdGZpbmRPbWRiKG1lZGlhVGl0bGUpXG5cdFx0XHRcdC50aGVuKGZ1bmN0aW9uKG1ldGFkYXRhKSB7XG5cdFx0XHRcdFx0dmFyIG1lZGlhID0ge307XG5cdFx0XHRcdFx0bWVkaWEgPSBtZXRhZGF0YTtcblx0XHRcdFx0XHRtZWRpYS5faWQgPSBtZXRhZGF0YS5pbWRiLmlkO1xuXHRcdFx0XHRcdHNlbGYuY29sbGVjdGlvbi5pbnNlcnQobWVkaWEpO1xuXHRcdFx0XHRcdGNvbnNvbGUubG9nKG1lZGlhKTtcblx0XHRcdFx0XHRzZWxmLmRiLnNhdmVEYXRhYmFzZSgpO1xuXHRcdFx0XHR9KVxuXHRcdFx0XHQudGhlbihmdW5jdGlvbigpIHtcblx0XHRcdFx0XHRyZXNvbHZlKHNlbGYpO1xuXHRcdFx0XHR9LCBmdW5jdGlvbihlcnIpIHtcblx0XHRcdFx0XHRyZWplY3QoZXJyKTtcblx0XHRcdFx0fSk7XG5cdFx0fSlcblx0fTtcblxuXHRyZXR1cm4ge1xuXHRcdGRiOiBuZXcgbG9raShwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnYXBwLmRiJykpLFxuXHRcdGNvbGxlY3Rpb246IG51bGwsXG5cdFx0bG9hZGVkOiBmYWxzZSxcblx0XHRpbml0OiBmdW5jdGlvbigpIHtcblx0XHRcdHZhciBzZWxmID0gdGhpcztcblx0XHRcdHNlbGYuZGIubG9hZERhdGFiYXNlKHt9LCBmdW5jdGlvbigpIHtcblx0XHRcdFx0cmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuXHRcdFx0XHRcdFx0aWYgKHNlbGYuZGIuY29sbGVjdGlvbnMubGVuZ3RoKSB7XG5cdFx0XHRcdFx0XHRcdHNlbGYuY29sbGVjdGlvbiA9IHNlbGYuZGIuZ2V0Q29sbGVjdGlvbignbWVkaWEnKTtcblx0XHRcdFx0XHRcdFx0c2VsZi5sb2FkZWQgPSB0cnVlO1xuXHRcdFx0XHRcdFx0XHRyZXR1cm4gcmVzb2x2ZShzZWxmKTtcblx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdHNlbGYuZGIuYWRkQ29sbGVjdGlvbignbWVkaWEnKTtcblx0XHRcdFx0XHRcdFx0c2VsZi5kYi5zYXZlRGF0YWJhc2UoKTtcblx0XHRcdFx0XHRcdFx0c2VsZi5jb2xsZWN0aW9uID0gc2VsZi5kYi5nZXRDb2xsZWN0aW9uKCdtZWRpYScpO1xuXHRcdFx0XHRcdFx0XHRzZWxmLmxvYWRlZCA9IHRydWU7XG5cdFx0XHRcdFx0XHRcdHJldHVybiByZXNvbHZlKHNlbGYpXG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fSlcblx0XHRcdFx0XHQudGhlbihmdW5jdGlvbigpIHtcblx0XHRcdFx0XHRcdGNvbnNvbGUubG9nKCdpbiB0aGUgZmFjdG9yeScsIHNlbGYpO1xuXHRcdFx0XHRcdFx0JHJvb3RTY29wZS4kZW1pdCgnZGJMb2FkZWQnKTtcblx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdC50aGVuKG51bGwsIGZ1bmN0aW9uKGVycikge1xuXHRcdFx0XHRcdFx0Y29uc29sZS5sb2coZXJyKVxuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0Ly8gLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuXHRcdFx0XHRcdC8vIFx0Y29uc29sZS5sb2coZXJyKTtcblx0XHRcdFx0XHQvLyB9KVxuXHRcdFx0fSlcblx0XHR9LFxuXHRcdGZpbmRNZWRpYTogZnVuY3Rpb24obWVkaWFJZCkge1xuXHRcdFx0dmFyIHNlbGYgPSB0aGlzO1xuXHRcdFx0cmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuXHRcdFx0XHRpZiAoc2VsZi5sb2FkZWQgJiYgc2VsZi5kYi5nZXRDb2xsZWN0aW9uKCdtZWRpYScpKSB7XG5cdFx0XHRcdFx0cmV0dXJuIHJlc29sdmUoc2VsZi5jb2xsZWN0aW9uLmZpbmQoe1xuXHRcdFx0XHRcdFx0XCJfaWRcIjogbWVkaWFJZFxuXHRcdFx0XHRcdH0pKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRyZWplY3QobmV3IEVycm9yKCdkYiBpcyBub3QgcmVhZHknKSk7XG5cdFx0XHRcdH1cblx0XHRcdH0pXG5cdFx0fSxcblx0XHQvL25vdCBiZWluZyB1c2VkIGVpdGhlclxuXHRcdGFkZE1lZGlhOiBhZGRNZWRpYSxcblx0XHRmaW5kT3JDcmVhdGU6IGZ1bmN0aW9uKG1lZGlhVGl0bGUsIHNlYXNvbnMpIHtcblx0XHRcdHZhciBzZWxmID0gdGhpcztcblx0XHRcdGNvbnNvbGUubG9nKCdpbiB0aGUgZmluZE9yQ3JlYXRlJylcblx0XHRcdHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcblx0XHRcdFx0aWYgKHNlbGYubG9hZGVkICYmIHNlbGYuZGIuZ2V0Q29sbGVjdGlvbignbWVkaWEnKSkge1xuXHRcdFx0XHRcdGZpbmRPbWRiKG1lZGlhVGl0bGUpXG5cdFx0XHRcdFx0XHQudGhlbihmdW5jdGlvbihtZXRhZGF0YSkge1xuXHRcdFx0XHRcdFx0XHRpZiAoc2VsZi5jb2xsZWN0aW9uLmZpbmQoe1xuXHRcdFx0XHRcdFx0XHRcdFx0J19pZCc6IG1ldGFkYXRhLmltZGIuaWRcblx0XHRcdFx0XHRcdFx0XHR9KS5sZW5ndGggPiAwKSB7XG5cdFx0XHRcdFx0XHRcdFx0Y29uc29sZS5sb2coc2VsZi5jb2xsZWN0aW9uLmZpbmQoe1xuXHRcdFx0XHRcdFx0XHRcdFx0J3RpdGxlJzogbWVkaWFUaXRsZVxuXHRcdFx0XHRcdFx0XHRcdH0pLmxlbmd0aCk7XG5cdFx0XHRcdFx0XHRcdFx0Ly9TdGlsbCBuZWVkIHRvIHJldHVybiBhY3R1YWwgZmlsZVxuXHRcdFx0XHRcdFx0XHRcdHJldHVybiByZXNvbHZlKG51bGwpO1xuXHRcdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRcdGNvbnNvbGUubG9nKCdjcmVhdGluZycpO1xuXHRcdFx0XHRcdFx0XHRcdHZhciBtZWRpYSA9IHt9O1xuXHRcdFx0XHRcdFx0XHRcdG1lZGlhID0gbWV0YWRhdGE7XG5cdFx0XHRcdFx0XHRcdFx0bWVkaWEuX2lkID0gbWV0YWRhdGEuaW1kYi5pZDtcblx0XHRcdFx0XHRcdFx0XHRtZWRpYS5zZWFzb25zID0gc2Vhc29ucztcblx0XHRcdFx0XHRcdFx0XHRzZWxmLmNvbGxlY3Rpb24uaW5zZXJ0KG1lZGlhKTtcblx0XHRcdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhtZWRpYSk7XG5cdFx0XHRcdFx0XHRcdFx0c2VsZi5kYi5zYXZlRGF0YWJhc2UoKTtcblx0XHRcdFx0XHRcdFx0XHRyZXNvbHZlKHNlbGYpO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHJlamVjdChuZXcgRXJyb3IoJ2RiIGlzIG5vdCByZWFkeScpKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0fSxcblx0XHR1cGRhdGVUaW1lc3RhbXA6IGZ1bmN0aW9uKG1lZGlhVGl0bGUsIHNlYXNvbiwgZXBpc29kZSwgbmV3VGltZXN0YW1wKSB7XG5cdFx0XHRyZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG5cdFx0XHRcdFx0aWYgKHNlbGYubG9hZGVkICYmIHNlbGYuZGIuZ2V0Q29sbGVjdGlvbignbWVkaWEnKSkge1xuXHRcdFx0XHRcdFx0ZmluZE9tZGIobWVkaWFUaXRsZSlcblx0XHRcdFx0XHRcdFx0LnRoZW4oZnVuY3Rpb24obWV0YWRhdGEpIHtcblx0XHRcdFx0XHRcdFx0XHRcdGlmIChzZWxmLmNvbGxlY3Rpb24uZmluZCh7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0J19pZCc6IG1ldGFkYXRhLmltZGIuaWRcblx0XHRcdFx0XHRcdFx0XHRcdFx0fSkpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0dmFyIHVwZGF0aW5nID0gc2VsZi5jb2xsZWN0aW9uLmZpbmRPbmUoe1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdCdfaWQnOiBtZXRhZGF0YS5pbWRiLmlkXG5cdFx0XHRcdFx0XHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0XHRcdFx0XHRcdHVwZGF0aW5nLnNlYXNvbnNbc2Vhc29uXVtlcGlzb2RlXS50aW1lc3RhbXAgPSBuZXdUaW1lc3RhbXA7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdHJlc29sdmUoc2VsZi5jb2xsZWN0aW9uLnVwZGF0ZSh1cGRhdGluZykpO1xuXHRcdFx0XHRcdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0cmVqZWN0KG5ldyBFcnJvcignbWVkaWEgbm90IGZvdW5kJykpO1xuXHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0pXG5cdFx0XHR9XG5cdH07XG59KTtcbiIsImFuZ0FwcC5jb250cm9sbGVyKCdTaWRlYmFyQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSkge1xuXG4gIC8vTGVmdG92ZXIgYXR0ZW1wdHMgdG8gbWFrZSBzaWRlYmFyIHRvZ2dsZWFibGVcbiAgLy8gJHNjb3BlLm1lbnVBY3RpdmUgPSBmYWxzZTtcbiAgLy8gdmFyIHdyYXBwZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2lkZWJhci13cmFwcGVyJylcbiAgLy8gJHNjb3BlLnRvZ2dsZU1lbnUgPSBmdW5jdGlvbihlKSB7XG4gIC8vICAgLy8gd3JhcHBlci50b2dnbGVDbGFzcyhcInRvZ2dsZWRcIik7XG4gIC8vICAgJHNjb3BlLm1lbnVBY3RpdmUgPSAhJHNjb3BlLm1lbnVBY3RpdmU7XG4gIC8vfVxuXG4gIC8vcGxhY2Vob2xkZXIgZm9yIG1ha2luZyBuZXcgcGxheWxpc3RzXG5cblxufSlcbiIsImFuZ0FwcC5kaXJlY3RpdmUoJ3NpZGViYXInLCBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHtcbiAgICByZXN0cmljdDogJ0UnLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9hcHAvanMvZGlyZWN0aXZlcy9zaWRlYmFyL3NpZGViYXIuaHRtbCdcbiAgfTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
