'use strict';

var angApp = angular.module('main', ['ui.router']);

angApp.config(function ($urlRouterProvider) {
	$urlRouterProvider.otherwise('/');
});

angApp.controller('DashboardCtrl', function ($rootScope, $scope, Storage, initialize) {
	//code
	$rootScope.$on('dbLoaded', function () {
		console.log('initialized', Storage.findOrCreate('Rick and Morty').then(function (result) {
			return console.log(result);
		}));
		// .then(function(result) {console.log(result)});
	});
});

angApp.config(function ($stateProvider) {
	$stateProvider.state('dashboardState', {
		url: '/test',
		templateUrl: './app/js/dashboard/dashboard.html'
	});
});

angApp.controller('ExplorerCtrl', function ($scope, $element, vidConstants) {
	// Code to make the 'file holder div' take in
	// file path names
	var homedir = process.platform === 'win32' ? process.env.HOMEPATH : process.env.HOME;
	var shell = require('electron').shell;
	// var finder = require('./server/algorithms/search.js')
	var fs = require('fs');
	var path = require('path');
	var find = require('findit');
	var parseVideo = require('video-name-parser');

	//Button called "browse", opens homedirectory of user
	$scope.openHome = function () {
		return shell.showItemInFolder(homedir);
	};

	// --------------------------
	// Code that allows you to recurse through the directories
	//provided and return file names that end with certain exts

	var holder = document.getElementById('fileholder');
	holder.ondragover = function () {
		this.className = 'hover';
		return false;
	};
	holder.ondragleave = function () {
		this.className = '';
		return false;
	};
	holder.ondrop = function (e) {
		var dataPathArray = [];
		var soln = [];
		e.preventDefault();
		for (var i = 0; i < e.dataTransfer.files.length; ++i) {
			dataPathArray.push(e.dataTransfer.files[i].path);
		}
		dataPathArray.forEach(function (data) {
			var finder = find(data);
			finder.on('file', function (file, stat) {
				if (vidConstants.vidExtensions.indexOf(path.extname(file)) !== -1) {
					var parsed = parseVideo(file);
					soln.push(parsed);
				}
				console.log("Thank you for your patience!");
			});
			finder.on('end', function (file, stat) {
				// soln.forEach()
				console.log('soln', soln);
			});
		});
		return false;
	};
});

angApp.factory('vidConstants', function () {
	return {
		vidExtensions: ['.mkv', '.avi', '.mov', '.gifv', '.flv']
	};
});

angApp.config(function ($stateProvider) {
	$stateProvider.state('explorerState', {
		url: '/',
		templateUrl: './app/js/explorer/explorer.html',
		controller: 'ExplorerCtrl'
	});
});

'use strict';
var loki = require('lokijs'),
    path = require('path'),
    Promise = require('bluebird'),
    omdb = Promise.promisifyAll(require('omdb'));

angApp.factory('Storage', function ($rootScope) {
	function findOmdb(name) {
		console.log('in omdb function', name);
		return omdb.searchAsync(name).then(function (results) {
			if (results.length < 1) return;
			if (results.length >= 1) {
				return omdb.getAsync(results[0].imdb);
			}
		});
	};
	//Not being used anymore
	function addMedia(mediaTitle) {
		var self = this;
		console.log(self);
		return new Promise(function (resolve, reject) {
			console.log(self);
			findOmdb(mediaTitle).then(function (metadata) {
				var media = {};
				media = metadata;
				media._id = metadata.imdb.id;
				self.collection.insert(media);
				console.log(media);
				self.db.saveDatabase();
			}).then(function () {
				resolve(self);
			}, function (err) {
				reject(err);
			});
		});
	};

	return {
		db: new loki(path.resolve(__dirname, 'app.db')),
		collection: null,
		loaded: false,
		init: function init() {
			var self = this;
			self.db.loadDatabase({}, function () {
				return new Promise(function (resolve, reject) {
					if (self.db.collections.length) {
						self.collection = self.db.getCollection('media');
						self.loaded = true;
						return resolve(self);
					} else {
						self.db.addCollection('media');
						self.db.saveDatabase();
						self.collection = self.db.getCollection('media');
						self.loaded = true;
						return resolve(self);
					}
				}).then(function () {
					console.log('in the factory', self);
					$rootScope.$emit('dbLoaded');
				}).then(null, function (err) {
					console.log(err);
				});
				// .catch(function(err) {
				// 	console.log(err);
				// })
			});
		},
		findMedia: function findMedia(mediaId) {
			var self = this;
			return new Promise(function (resolve, reject) {
				if (self.loaded && self.db.getCollection('media')) {
					return resolve(self.collection.find({
						"_id": mediaId
					}));
				} else {
					reject(new Error('db is not ready'));
				}
			});
		},
		//not being used either
		addMedia: addMedia,
		findOrCreate: function findOrCreate(mediaTitle) {
			var self = this;
			console.log('in the findOrCreate');
			return new Promise(function (resolve, reject) {
				if (self.loaded && self.db.getCollection('media')) {
					findOmdb(mediaTitle).then(function (metadata) {
						if (self.collection.find({
							'_id': metadata.imdb.id
						}).length > 0) {
							console.log(self.collection.find({
								'title': mediaTitle
							}).length);
							//Still need to return actual file
							return resolve(null);
						} else {
							console.log('creating');
							var media = {};
							media = metadata;
							media._id = metadata.imdb.id;
							self.collection.insert(media);
							console.log(media);
							self.db.saveDatabase();
							resolve(self);
						}
					});
				} else {
					reject(new Error('db is not ready'));
				}
			});
		}
	};
});

angApp.controller('SidebarCtrl', function ($scope) {

	//Leftover attempts to make sidebar toggleable
	// $scope.menuActive = false;
	// var wrapper = document.getElementById('sidebar-wrapper')
	// $scope.toggleMenu = function(e) {
	//   // wrapper.toggleClass("toggled");
	//   $scope.menuActive = !$scope.menuActive;
	//}

	//placeholder for making new playlists

});

angApp.directive('sidebar', function () {
	return {
		restrict: 'E',
		templateUrl: './app/js/directives/sidebar/sidebar.html'
	};
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImpzL2Rhc2hib2FyZC9kYXNoYm9hcmQuY29udHJvbGxlci5qcyIsImpzL2Rhc2hib2FyZC9kYXNoYm9hcmQuc3RhdGUuanMiLCJqcy9leHBsb3Jlci9leHBsb3Jlci5jb250cm9sbGVyLmpzIiwianMvZXhwbG9yZXIvZXhwbG9yZXIuc3RhdGUuanMiLCJqcy9jb21tb24vZmFjdG9yaWVzL0NhY2hlRmFjdG9yeS5qcyIsImpzL2RpcmVjdGl2ZXMvc2lkZWJhci9zaWRlYmFyLmNvbnRyb2xsZXIuanMiLCJqcy9kaXJlY3RpdmVzL3NpZGViYXIvc2lkZWJhci5kaXJlY3RpdmUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFBLE1BQUEsR0FBQSxPQUFBLENBQUEsTUFBQSxDQUFBLE1BQUEsRUFBQSxDQUFBLFdBQUEsQ0FBQSxDQUFBLENBQUE7O0FBRUEsTUFBQSxDQUFBLE1BQUEsQ0FBQSxVQUFBLGtCQUFBLEVBQUE7QUFDQSxtQkFBQSxDQUFBLFNBQUEsQ0FBQSxHQUFBLENBQUEsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUNKQSxNQUFBLENBQUEsVUFBQSxDQUFBLGVBQUEsRUFBQSxVQUFBLFVBQUEsRUFBQSxNQUFBLEVBQUEsT0FBQSxFQUFBLFVBQUEsRUFBQTs7QUFFQSxXQUFBLENBQUEsR0FBQSxDQUFBLFVBQUEsRUFBQSxZQUFBO0FBQ0EsU0FBQSxDQUFBLEdBQUEsQ0FBQSxhQUFBLEVBQUEsT0FBQSxDQUFBLFlBQUEsQ0FBQSxnQkFBQSxDQUFBLENBQUEsSUFBQSxDQUFBLFVBQUEsTUFBQTtVQUFBLE9BQUEsQ0FBQSxHQUFBLENBQUEsTUFBQSxDQUFBO0dBQUEsQ0FBQSxDQUFBLENBQUE7O0VBRUEsQ0FBQSxDQUFBO0NBRUEsQ0FBQSxDQUFBOztBQ1BBLE1BQUEsQ0FBQSxNQUFBLENBQUEsVUFBQSxjQUFBLEVBQUE7QUFDQSxlQUFBLENBQUEsS0FBQSxDQUFBLGdCQUFBLEVBQUE7QUFDQSxLQUFBLEVBQUEsT0FBQTtBQUNBLGFBQUEsRUFBQSxtQ0FBQTtFQUNBLENBQUEsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUNMQSxNQUFBLENBQUEsVUFBQSxDQUFBLGNBQUEsRUFBQSxVQUFBLE1BQUEsRUFBQSxRQUFBLEVBQUEsWUFBQSxFQUFBOzs7QUFHQSxLQUFBLE9BQUEsR0FBQSxPQUFBLENBQUEsUUFBQSxLQUFBLE9BQUEsR0FBQSxPQUFBLENBQUEsR0FBQSxDQUFBLFFBQUEsR0FDQSxPQUFBLENBQUEsR0FBQSxDQUFBLElBQUEsQ0FBQTtBQUNBLEtBQUEsS0FBQSxHQUFBLE9BQUEsQ0FBQSxVQUFBLENBQUEsQ0FBQSxLQUFBLENBQUE7O0FBRUEsS0FBQSxFQUFBLEdBQUEsT0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBO0FBQ0EsS0FBQSxJQUFBLEdBQUEsT0FBQSxDQUFBLE1BQUEsQ0FBQSxDQUFBO0FBQ0EsS0FBQSxJQUFBLEdBQUEsT0FBQSxDQUFBLFFBQUEsQ0FBQSxDQUFBO0FBQ0EsS0FBQSxVQUFBLEdBQUEsT0FBQSxDQUFBLG1CQUFBLENBQUEsQ0FBQTs7O0FBR0EsT0FBQSxDQUFBLFFBQUEsR0FBQSxZQUFBO0FBQ0EsU0FBQSxLQUFBLENBQUEsZ0JBQUEsQ0FBQSxPQUFBLENBQUEsQ0FBQTtFQUNBLENBQUE7Ozs7OztBQU1BLEtBQUEsTUFBQSxHQUFBLFFBQUEsQ0FBQSxjQUFBLENBQUEsWUFBQSxDQUFBLENBQUE7QUFDQSxPQUFBLENBQUEsVUFBQSxHQUFBLFlBQUE7QUFDQSxNQUFBLENBQUEsU0FBQSxHQUFBLE9BQUEsQ0FBQTtBQUNBLFNBQUEsS0FBQSxDQUFBO0VBQ0EsQ0FBQTtBQUNBLE9BQUEsQ0FBQSxXQUFBLEdBQUEsWUFBQTtBQUNBLE1BQUEsQ0FBQSxTQUFBLEdBQUEsRUFBQSxDQUFBO0FBQ0EsU0FBQSxLQUFBLENBQUE7RUFDQSxDQUFBO0FBQ0EsT0FBQSxDQUFBLE1BQUEsR0FBQSxVQUFBLENBQUEsRUFBQTtBQUNBLE1BQUEsYUFBQSxHQUFBLEVBQUEsQ0FBQTtBQUNBLE1BQUEsSUFBQSxHQUFBLEVBQUEsQ0FBQTtBQUNBLEdBQUEsQ0FBQSxjQUFBLEVBQUEsQ0FBQTtBQUNBLE9BQUEsSUFBQSxDQUFBLEdBQUEsQ0FBQSxFQUFBLENBQUEsR0FBQSxDQUFBLENBQUEsWUFBQSxDQUFBLEtBQUEsQ0FBQSxNQUFBLEVBQUEsRUFBQSxDQUFBLEVBQUE7QUFDQSxnQkFBQSxDQUFBLElBQUEsQ0FBQSxDQUFBLENBQUEsWUFBQSxDQUFBLEtBQUEsQ0FBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQTtHQUNBO0FBQ0EsZUFBQSxDQUFBLE9BQUEsQ0FBQSxVQUFBLElBQUEsRUFBQTtBQUNBLE9BQUEsTUFBQSxHQUFBLElBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQTtBQUNBLFNBQUEsQ0FBQSxFQUFBLENBQUEsTUFBQSxFQUFBLFVBQUEsSUFBQSxFQUFBLElBQUEsRUFBQTtBQUNBLFFBQUEsWUFBQSxDQUFBLGFBQUEsQ0FBQSxPQUFBLENBQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQSxLQUNBLENBQUEsQ0FBQSxFQUFBO0FBQ0EsU0FBQSxNQUFBLEdBQUEsVUFBQSxDQUFBLElBQUEsQ0FBQSxDQUFBO0FBQ0EsU0FBQSxDQUFBLElBQUEsQ0FBQSxNQUFBLENBQUEsQ0FBQTtLQUNBO0FBQ0EsV0FBQSxDQUFBLEdBQUEsQ0FBQSw4QkFBQSxDQUFBLENBQUE7SUFDQSxDQUFBLENBQUE7QUFDQSxTQUFBLENBQUEsRUFBQSxDQUFBLEtBQUEsRUFBQSxVQUFBLElBQUEsRUFBQSxJQUFBLEVBQUE7O0FBRUEsV0FBQSxDQUFBLEdBQUEsQ0FBQSxNQUFBLEVBQUEsSUFBQSxDQUFBLENBQUE7SUFDQSxDQUFBLENBQUE7R0FDQSxDQUFBLENBQUE7QUFDQSxTQUFBLEtBQUEsQ0FBQTtFQUNBLENBQUE7Q0FDQSxDQUFBLENBQUE7O0FBR0EsTUFBQSxDQUFBLE9BQUEsQ0FBQSxjQUFBLEVBQUEsWUFBQTtBQUNBLFFBQUE7QUFDQSxlQUFBLEVBQUEsQ0FBQSxNQUFBLEVBQUEsTUFBQSxFQUFBLE1BQUEsRUFBQSxPQUFBLEVBQUEsTUFBQSxDQUFBO0VBQ0EsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUM3REEsTUFBQSxDQUFBLE1BQUEsQ0FBQSxVQUFBLGNBQUEsRUFBQTtBQUNBLGVBQUEsQ0FBQSxLQUFBLENBQUEsZUFBQSxFQUFBO0FBQ0EsS0FBQSxFQUFBLEdBQUE7QUFDQSxhQUFBLEVBQUEsaUNBQUE7QUFDQSxZQUFBLEVBQUEsY0FBQTtFQUNBLENBQUEsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUNOQSxZQUFBLENBQUE7QUFDQSxJQUFBLElBQUEsR0FBQSxPQUFBLENBQUEsUUFBQSxDQUFBO0lBQ0EsSUFBQSxHQUFBLE9BQUEsQ0FBQSxNQUFBLENBQUE7SUFDQSxPQUFBLEdBQUEsT0FBQSxDQUFBLFVBQUEsQ0FBQTtJQUNBLElBQUEsR0FBQSxPQUFBLENBQUEsWUFBQSxDQUFBLE9BQUEsQ0FBQSxNQUFBLENBQUEsQ0FBQSxDQUFBOztBQUdBLE1BQUEsQ0FBQSxPQUFBLENBQUEsU0FBQSxFQUFBLFVBQUEsVUFBQSxFQUFBO0FBQ0EsVUFBQSxRQUFBLENBQUEsSUFBQSxFQUFBO0FBQ0EsU0FBQSxDQUFBLEdBQUEsQ0FBQSxrQkFBQSxFQUFBLElBQUEsQ0FBQSxDQUFBO0FBQ0EsU0FBQSxJQUFBLENBQUEsV0FBQSxDQUFBLElBQUEsQ0FBQSxDQUNBLElBQUEsQ0FBQSxVQUFBLE9BQUEsRUFBQTtBQUNBLE9BQUEsT0FBQSxDQUFBLE1BQUEsR0FBQSxDQUFBLEVBQUEsT0FBQTtBQUNBLE9BQUEsT0FBQSxDQUFBLE1BQUEsSUFBQSxDQUFBLEVBQUE7QUFDQSxXQUFBLElBQUEsQ0FBQSxRQUFBLENBQUEsT0FBQSxDQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBO0lBQ0E7R0FDQSxDQUFBLENBQUE7RUFDQSxDQUFBOztBQUVBLFVBQUEsUUFBQSxDQUFBLFVBQUEsRUFBQTtBQUNBLE1BQUEsSUFBQSxHQUFBLElBQUEsQ0FBQTtBQUNBLFNBQUEsQ0FBQSxHQUFBLENBQUEsSUFBQSxDQUFBLENBQUE7QUFDQSxTQUFBLElBQUEsT0FBQSxDQUFBLFVBQUEsT0FBQSxFQUFBLE1BQUEsRUFBQTtBQUNBLFVBQUEsQ0FBQSxHQUFBLENBQUEsSUFBQSxDQUFBLENBQUE7QUFDQSxXQUFBLENBQUEsVUFBQSxDQUFBLENBQ0EsSUFBQSxDQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsUUFBQSxLQUFBLEdBQUEsRUFBQSxDQUFBO0FBQ0EsU0FBQSxHQUFBLFFBQUEsQ0FBQTtBQUNBLFNBQUEsQ0FBQSxHQUFBLEdBQUEsUUFBQSxDQUFBLElBQUEsQ0FBQSxFQUFBLENBQUE7QUFDQSxRQUFBLENBQUEsVUFBQSxDQUFBLE1BQUEsQ0FBQSxLQUFBLENBQUEsQ0FBQTtBQUNBLFdBQUEsQ0FBQSxHQUFBLENBQUEsS0FBQSxDQUFBLENBQUE7QUFDQSxRQUFBLENBQUEsRUFBQSxDQUFBLFlBQUEsRUFBQSxDQUFBO0lBQ0EsQ0FBQSxDQUNBLElBQUEsQ0FBQSxZQUFBO0FBQ0EsV0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBO0lBQ0EsRUFBQSxVQUFBLEdBQUEsRUFBQTtBQUNBLFVBQUEsQ0FBQSxHQUFBLENBQUEsQ0FBQTtJQUNBLENBQUEsQ0FBQTtHQUNBLENBQUEsQ0FBQTtFQUNBLENBQUE7O0FBRUEsUUFBQTtBQUNBLElBQUEsRUFBQSxJQUFBLElBQUEsQ0FBQSxJQUFBLENBQUEsT0FBQSxDQUFBLFNBQUEsRUFBQSxRQUFBLENBQUEsQ0FBQTtBQUNBLFlBQUEsRUFBQSxJQUFBO0FBQ0EsUUFBQSxFQUFBLEtBQUE7QUFDQSxNQUFBLEVBQUEsZ0JBQUE7QUFDQSxPQUFBLElBQUEsR0FBQSxJQUFBLENBQUE7QUFDQSxPQUFBLENBQUEsRUFBQSxDQUFBLFlBQUEsQ0FBQSxFQUFBLEVBQUEsWUFBQTtBQUNBLFdBQUEsSUFBQSxPQUFBLENBQUEsVUFBQSxPQUFBLEVBQUEsTUFBQSxFQUFBO0FBQ0EsU0FBQSxJQUFBLENBQUEsRUFBQSxDQUFBLFdBQUEsQ0FBQSxNQUFBLEVBQUE7QUFDQSxVQUFBLENBQUEsVUFBQSxHQUFBLElBQUEsQ0FBQSxFQUFBLENBQUEsYUFBQSxDQUFBLE9BQUEsQ0FBQSxDQUFBO0FBQ0EsVUFBQSxDQUFBLE1BQUEsR0FBQSxJQUFBLENBQUE7QUFDQSxhQUFBLE9BQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQTtNQUNBLE1BQUE7QUFDQSxVQUFBLENBQUEsRUFBQSxDQUFBLGFBQUEsQ0FBQSxPQUFBLENBQUEsQ0FBQTtBQUNBLFVBQUEsQ0FBQSxFQUFBLENBQUEsWUFBQSxFQUFBLENBQUE7QUFDQSxVQUFBLENBQUEsVUFBQSxHQUFBLElBQUEsQ0FBQSxFQUFBLENBQUEsYUFBQSxDQUFBLE9BQUEsQ0FBQSxDQUFBO0FBQ0EsVUFBQSxDQUFBLE1BQUEsR0FBQSxJQUFBLENBQUE7QUFDQSxhQUFBLE9BQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQTtNQUNBO0tBQ0EsQ0FBQSxDQUNBLElBQUEsQ0FBQSxZQUFBO0FBQ0EsWUFBQSxDQUFBLEdBQUEsQ0FBQSxnQkFBQSxFQUFBLElBQUEsQ0FBQSxDQUFBO0FBQ0EsZUFBQSxDQUFBLEtBQUEsQ0FBQSxVQUFBLENBQUEsQ0FBQTtLQUNBLENBQUEsQ0FDQSxJQUFBLENBQUEsSUFBQSxFQUFBLFVBQUEsR0FBQSxFQUFBO0FBQ0EsWUFBQSxDQUFBLEdBQUEsQ0FBQSxHQUFBLENBQUEsQ0FBQTtLQUNBLENBQUEsQ0FBQTs7OztJQUlBLENBQUEsQ0FBQTtHQUNBO0FBQ0EsV0FBQSxFQUFBLG1CQUFBLE9BQUEsRUFBQTtBQUNBLE9BQUEsSUFBQSxHQUFBLElBQUEsQ0FBQTtBQUNBLFVBQUEsSUFBQSxPQUFBLENBQUEsVUFBQSxPQUFBLEVBQUEsTUFBQSxFQUFBO0FBQ0EsUUFBQSxJQUFBLENBQUEsTUFBQSxJQUFBLElBQUEsQ0FBQSxFQUFBLENBQUEsYUFBQSxDQUFBLE9BQUEsQ0FBQSxFQUFBO0FBQ0EsWUFBQSxPQUFBLENBQUEsSUFBQSxDQUFBLFVBQUEsQ0FBQSxJQUFBLENBQUE7QUFDQSxXQUFBLEVBQUEsT0FBQTtNQUNBLENBQUEsQ0FBQSxDQUFBO0tBQ0EsTUFBQTtBQUNBLFdBQUEsQ0FBQSxJQUFBLEtBQUEsQ0FBQSxpQkFBQSxDQUFBLENBQUEsQ0FBQTtLQUNBO0lBQ0EsQ0FBQSxDQUFBO0dBQ0E7O0FBRUEsVUFBQSxFQUFBLFFBQUE7QUFDQSxjQUFBLEVBQUEsc0JBQUEsVUFBQSxFQUFBO0FBQ0EsT0FBQSxJQUFBLEdBQUEsSUFBQSxDQUFBO0FBQ0EsVUFBQSxDQUFBLEdBQUEsQ0FBQSxxQkFBQSxDQUFBLENBQUE7QUFDQSxVQUFBLElBQUEsT0FBQSxDQUFBLFVBQUEsT0FBQSxFQUFBLE1BQUEsRUFBQTtBQUNBLFFBQUEsSUFBQSxDQUFBLE1BQUEsSUFBQSxJQUFBLENBQUEsRUFBQSxDQUFBLGFBQUEsQ0FBQSxPQUFBLENBQUEsRUFBQTtBQUNBLGFBQUEsQ0FBQSxVQUFBLENBQUEsQ0FDQSxJQUFBLENBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxVQUFBLElBQUEsQ0FBQSxVQUFBLENBQUEsSUFBQSxDQUFBO0FBQ0EsWUFBQSxFQUFBLFFBQUEsQ0FBQSxJQUFBLENBQUEsRUFBQTtPQUNBLENBQUEsQ0FBQSxNQUFBLEdBQUEsQ0FBQSxFQUFBO0FBQ0EsY0FBQSxDQUFBLEdBQUEsQ0FBQSxJQUFBLENBQUEsVUFBQSxDQUFBLElBQUEsQ0FBQTtBQUNBLGVBQUEsRUFBQSxVQUFBO1FBQ0EsQ0FBQSxDQUFBLE1BQUEsQ0FBQSxDQUFBOztBQUVBLGNBQUEsT0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBO09BQ0EsTUFBQTtBQUNBLGNBQUEsQ0FBQSxHQUFBLENBQUEsVUFBQSxDQUFBLENBQUE7QUFDQSxXQUFBLEtBQUEsR0FBQSxFQUFBLENBQUE7QUFDQSxZQUFBLEdBQUEsUUFBQSxDQUFBO0FBQ0EsWUFBQSxDQUFBLEdBQUEsR0FBQSxRQUFBLENBQUEsSUFBQSxDQUFBLEVBQUEsQ0FBQTtBQUNBLFdBQUEsQ0FBQSxVQUFBLENBQUEsTUFBQSxDQUFBLEtBQUEsQ0FBQSxDQUFBO0FBQ0EsY0FBQSxDQUFBLEdBQUEsQ0FBQSxLQUFBLENBQUEsQ0FBQTtBQUNBLFdBQUEsQ0FBQSxFQUFBLENBQUEsWUFBQSxFQUFBLENBQUE7QUFDQSxjQUFBLENBQUEsSUFBQSxDQUFBLENBQUE7T0FDQTtNQUNBLENBQUEsQ0FBQTtLQUNBLE1BQUE7QUFDQSxXQUFBLENBQUEsSUFBQSxLQUFBLENBQUEsaUJBQUEsQ0FBQSxDQUFBLENBQUE7S0FDQTtJQUNBLENBQUEsQ0FBQTtHQUNBO0VBQ0EsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUN2SEEsTUFBQSxDQUFBLFVBQUEsQ0FBQSxhQUFBLEVBQUEsVUFBQSxNQUFBLEVBQUE7Ozs7Ozs7Ozs7OztDQWFBLENBQUEsQ0FBQTs7QUNiQSxNQUFBLENBQUEsU0FBQSxDQUFBLFNBQUEsRUFBQSxZQUFBO0FBQ0EsUUFBQTtBQUNBLFVBQUEsRUFBQSxHQUFBO0FBQ0EsYUFBQSxFQUFBLDBDQUFBO0VBQ0EsQ0FBQTtDQUNBLENBQUEsQ0FBQSIsImZpbGUiOiJtYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGFuZ0FwcCA9IGFuZ3VsYXIubW9kdWxlKCdtYWluJywgWyd1aS5yb3V0ZXInXSk7XG5cbmFuZ0FwcC5jb25maWcoZnVuY3Rpb24oJHVybFJvdXRlclByb3ZpZGVyKSB7XG4gICR1cmxSb3V0ZXJQcm92aWRlci5vdGhlcndpc2UoJy8nKTtcbn0pXG4iLCJhbmdBcHAuY29udHJvbGxlcignRGFzaGJvYXJkQ3RybCcsIGZ1bmN0aW9uKCRyb290U2NvcGUsICRzY29wZSwgU3RvcmFnZSwgaW5pdGlhbGl6ZSl7XG4gIC8vY29kZVxuICAkcm9vdFNjb3BlLiRvbignZGJMb2FkZWQnLCBmdW5jdGlvbigpIHtcbiAgICBjb25zb2xlLmxvZygnaW5pdGlhbGl6ZWQnLCBTdG9yYWdlLmZpbmRPckNyZWF0ZSgnUmljayBhbmQgTW9ydHknKS50aGVuKHJlc3VsdD0+IGNvbnNvbGUubG9nKHJlc3VsdCkpKTtcbiAgICAvLyAudGhlbihmdW5jdGlvbihyZXN1bHQpIHtjb25zb2xlLmxvZyhyZXN1bHQpfSk7XG4gIH0pXG5cbn0pXG4iLCJhbmdBcHAuY29uZmlnKGZ1bmN0aW9uKCRzdGF0ZVByb3ZpZGVyKSB7XG4gICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCdkYXNoYm9hcmRTdGF0ZScsIHtcbiAgICB1cmw6ICcvdGVzdCcsXG4gICAgdGVtcGxhdGVVcmw6ICcuL2FwcC9qcy9kYXNoYm9hcmQvZGFzaGJvYXJkLmh0bWwnXG4gIH0pXG59KVxuIiwiYW5nQXBwLmNvbnRyb2xsZXIoJ0V4cGxvcmVyQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsIHZpZENvbnN0YW50cykge1xuICAvLyBDb2RlIHRvIG1ha2UgdGhlICdmaWxlIGhvbGRlciBkaXYnIHRha2UgaW5cbiAgLy8gZmlsZSBwYXRoIG5hbWVzXG4gIHZhciBob21lZGlyID0gKHByb2Nlc3MucGxhdGZvcm0gPT09ICd3aW4zMicpID8gcHJvY2Vzcy5lbnYuSE9NRVBBVEggOlxuICAgIHByb2Nlc3MuZW52LkhPTUU7XG4gIGNvbnN0IHNoZWxsID0gcmVxdWlyZSgnZWxlY3Ryb24nKS5zaGVsbDtcbiAgLy8gdmFyIGZpbmRlciA9IHJlcXVpcmUoJy4vc2VydmVyL2FsZ29yaXRobXMvc2VhcmNoLmpzJylcbiAgdmFyIGZzID0gcmVxdWlyZSgnZnMnKTtcbiAgdmFyIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG4gIHZhciBmaW5kID0gcmVxdWlyZSgnZmluZGl0Jyk7XG4gIHZhciBwYXJzZVZpZGVvID0gcmVxdWlyZSgndmlkZW8tbmFtZS1wYXJzZXInKTtcblxuICAvL0J1dHRvbiBjYWxsZWQgXCJicm93c2VcIiwgb3BlbnMgaG9tZWRpcmVjdG9yeSBvZiB1c2VyXG4gICRzY29wZS5vcGVuSG9tZSA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBzaGVsbC5zaG93SXRlbUluRm9sZGVyKGhvbWVkaXIpO1xuICB9XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gQ29kZSB0aGF0IGFsbG93cyB5b3UgdG8gcmVjdXJzZSB0aHJvdWdoIHRoZSBkaXJlY3Rvcmllc1xuICAvL3Byb3ZpZGVkIGFuZCByZXR1cm4gZmlsZSBuYW1lcyB0aGF0IGVuZCB3aXRoIGNlcnRhaW4gZXh0c1xuXG4gIHZhciBob2xkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZmlsZWhvbGRlcicpO1xuICBob2xkZXIub25kcmFnb3ZlciA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuY2xhc3NOYW1lID0gJ2hvdmVyJztcbiAgICByZXR1cm4gZmFsc2U7XG4gIH07XG4gIGhvbGRlci5vbmRyYWdsZWF2ZSA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuY2xhc3NOYW1lID0gJyc7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9O1xuICBob2xkZXIub25kcm9wID0gZnVuY3Rpb24oZSkge1xuICAgIHZhciBkYXRhUGF0aEFycmF5ID0gW107XG4gICAgdmFyIHNvbG4gPSBbXTtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlLmRhdGFUcmFuc2Zlci5maWxlcy5sZW5ndGg7ICsraSkge1xuICAgICAgZGF0YVBhdGhBcnJheS5wdXNoKGUuZGF0YVRyYW5zZmVyLmZpbGVzW2ldLnBhdGgpO1xuICAgIH1cbiAgICBkYXRhUGF0aEFycmF5LmZvckVhY2goZnVuY3Rpb24oZGF0YSkge1xuICAgICAgdmFyIGZpbmRlciA9IGZpbmQoZGF0YSk7XG4gICAgICBmaW5kZXIub24oJ2ZpbGUnLCBmdW5jdGlvbihmaWxlLCBzdGF0KSB7XG4gICAgICAgIGlmICh2aWRDb25zdGFudHMudmlkRXh0ZW5zaW9ucy5pbmRleE9mKHBhdGguZXh0bmFtZShmaWxlKSkgIT09XG4gICAgICAgICAgLTEpIHtcbiAgICAgICAgICB2YXIgcGFyc2VkID0gcGFyc2VWaWRlbyhmaWxlKTtcbiAgICAgICAgICBzb2xuLnB1c2gocGFyc2VkKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZyhcIlRoYW5rIHlvdSBmb3IgeW91ciBwYXRpZW5jZSFcIik7XG4gICAgICB9KVxuICAgICAgZmluZGVyLm9uKCdlbmQnLCBmdW5jdGlvbihmaWxlLCBzdGF0KSB7XG4gICAgICAgIC8vIHNvbG4uZm9yRWFjaCgpXG4gICAgICAgIGNvbnNvbGUubG9nKCdzb2xuJywgc29sbilcbiAgICAgIH0pXG4gICAgfSlcbiAgICByZXR1cm4gZmFsc2U7XG4gIH07XG59KTtcblxuXG5hbmdBcHAuZmFjdG9yeSgndmlkQ29uc3RhbnRzJywgZnVuY3Rpb24oKSB7XG4gIHJldHVybiB7XG4gICAgdmlkRXh0ZW5zaW9uczogWycubWt2JywgJy5hdmknLCAnLm1vdicsICcuZ2lmdicsICcuZmx2J11cbiAgfVxufSlcbiIsImFuZ0FwcC5jb25maWcoZnVuY3Rpb24oJHN0YXRlUHJvdmlkZXIpIHtcbiAgJHN0YXRlUHJvdmlkZXIuc3RhdGUoJ2V4cGxvcmVyU3RhdGUnLCB7XG4gICAgdXJsOiAnLycsXG4gICAgdGVtcGxhdGVVcmw6ICcuL2FwcC9qcy9leHBsb3Jlci9leHBsb3Jlci5odG1sJyxcbiAgICBjb250cm9sbGVyOiAnRXhwbG9yZXJDdHJsJ1xuICB9KVxufSlcbiIsIid1c2Ugc3RyaWN0JztcbnZhciBsb2tpID0gcmVxdWlyZSgnbG9raWpzJyksXG5cdHBhdGggPSByZXF1aXJlKCdwYXRoJyksXG5cdFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZCcpLFxuXHRvbWRiID0gUHJvbWlzZS5wcm9taXNpZnlBbGwocmVxdWlyZSgnb21kYicpKTtcblxuXG5hbmdBcHAuZmFjdG9yeSgnU3RvcmFnZScsIGZ1bmN0aW9uKCRyb290U2NvcGUpIHtcblx0ZnVuY3Rpb24gZmluZE9tZGIobmFtZSkge1xuXHRcdGNvbnNvbGUubG9nKCdpbiBvbWRiIGZ1bmN0aW9uJywgbmFtZSk7XG5cdFx0cmV0dXJuIG9tZGIuc2VhcmNoQXN5bmMobmFtZSlcblx0XHRcdC50aGVuKGZ1bmN0aW9uKHJlc3VsdHMpIHtcblx0XHRcdFx0aWYgKHJlc3VsdHMubGVuZ3RoIDwgMSkgcmV0dXJuO1xuXHRcdFx0XHRpZiAocmVzdWx0cy5sZW5ndGggPj0gMSkge1xuXHRcdFx0XHRcdHJldHVybiBvbWRiLmdldEFzeW5jKHJlc3VsdHNbMF0uaW1kYik7XG5cdFx0XHRcdH1cblx0XHRcdH0pXG5cdH07XG5cdC8vTm90IGJlaW5nIHVzZWQgYW55bW9yZVxuXHRmdW5jdGlvbiBhZGRNZWRpYShtZWRpYVRpdGxlKSB7XG5cdFx0dmFyIHNlbGYgPSB0aGlzO1xuXHRcdGNvbnNvbGUubG9nKHNlbGYpO1xuXHRcdHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcblx0XHRcdGNvbnNvbGUubG9nKHNlbGYpO1xuXHRcdFx0ZmluZE9tZGIobWVkaWFUaXRsZSlcblx0XHRcdFx0LnRoZW4oZnVuY3Rpb24obWV0YWRhdGEpIHtcblx0XHRcdFx0XHR2YXIgbWVkaWEgPSB7fTtcblx0XHRcdFx0XHRtZWRpYSA9IG1ldGFkYXRhO1xuXHRcdFx0XHRcdG1lZGlhLl9pZCA9IG1ldGFkYXRhLmltZGIuaWQ7XG5cdFx0XHRcdFx0c2VsZi5jb2xsZWN0aW9uLmluc2VydChtZWRpYSk7XG5cdFx0XHRcdFx0Y29uc29sZS5sb2cobWVkaWEpO1xuXHRcdFx0XHRcdHNlbGYuZGIuc2F2ZURhdGFiYXNlKCk7XG5cdFx0XHRcdH0pXG5cdFx0XHRcdC50aGVuKGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRcdHJlc29sdmUoc2VsZik7XG5cdFx0XHRcdH0sIGZ1bmN0aW9uKGVycikge1xuXHRcdFx0XHRcdHJlamVjdChlcnIpO1xuXHRcdFx0XHR9KTtcblx0XHR9KVxuXHR9O1xuXG5cdHJldHVybiB7XG5cdFx0ZGI6IG5ldyBsb2tpKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICdhcHAuZGInKSksXG5cdFx0Y29sbGVjdGlvbjogbnVsbCxcblx0XHRsb2FkZWQ6IGZhbHNlLFxuXHRcdGluaXQ6IGZ1bmN0aW9uKCkge1xuXHRcdFx0dmFyIHNlbGYgPSB0aGlzO1xuXHRcdFx0c2VsZi5kYi5sb2FkRGF0YWJhc2Uoe30sIGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRyZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG5cdFx0XHRcdFx0XHRpZiAoc2VsZi5kYi5jb2xsZWN0aW9ucy5sZW5ndGgpIHtcblx0XHRcdFx0XHRcdFx0c2VsZi5jb2xsZWN0aW9uID0gc2VsZi5kYi5nZXRDb2xsZWN0aW9uKCdtZWRpYScpO1xuXHRcdFx0XHRcdFx0XHRzZWxmLmxvYWRlZCA9IHRydWU7XG5cdFx0XHRcdFx0XHRcdHJldHVybiByZXNvbHZlKHNlbGYpO1xuXHRcdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFx0c2VsZi5kYi5hZGRDb2xsZWN0aW9uKCdtZWRpYScpO1xuXHRcdFx0XHRcdFx0XHRzZWxmLmRiLnNhdmVEYXRhYmFzZSgpO1xuXHRcdFx0XHRcdFx0XHRzZWxmLmNvbGxlY3Rpb24gPSBzZWxmLmRiLmdldENvbGxlY3Rpb24oJ21lZGlhJyk7XG5cdFx0XHRcdFx0XHRcdHNlbGYubG9hZGVkID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0cmV0dXJuIHJlc29sdmUoc2VsZilcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdC50aGVuKGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRcdFx0Y29uc29sZS5sb2coJ2luIHRoZSBmYWN0b3J5Jywgc2VsZik7XG5cdFx0XHRcdFx0XHQkcm9vdFNjb3BlLiRlbWl0KCdkYkxvYWRlZCcpO1xuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0LnRoZW4obnVsbCwgZnVuY3Rpb24oZXJyKSB7XG5cdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhlcnIpXG5cdFx0XHRcdFx0fSlcblx0XHRcdFx0XHQvLyAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG5cdFx0XHRcdFx0Ly8gXHRjb25zb2xlLmxvZyhlcnIpO1xuXHRcdFx0XHRcdC8vIH0pXG5cdFx0XHR9KVxuXHRcdH0sXG5cdFx0ZmluZE1lZGlhOiBmdW5jdGlvbihtZWRpYUlkKSB7XG5cdFx0XHR2YXIgc2VsZiA9IHRoaXM7XG5cdFx0XHRyZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG5cdFx0XHRcdGlmIChzZWxmLmxvYWRlZCAmJiBzZWxmLmRiLmdldENvbGxlY3Rpb24oJ21lZGlhJykpIHtcblx0XHRcdFx0XHRyZXR1cm4gcmVzb2x2ZShzZWxmLmNvbGxlY3Rpb24uZmluZCh7XG5cdFx0XHRcdFx0XHRcIl9pZFwiOiBtZWRpYUlkXG5cdFx0XHRcdFx0fSkpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHJlamVjdChuZXcgRXJyb3IoJ2RiIGlzIG5vdCByZWFkeScpKTtcblx0XHRcdFx0fVxuXHRcdFx0fSlcblx0XHR9LFxuXHRcdC8vbm90IGJlaW5nIHVzZWQgZWl0aGVyXG5cdFx0YWRkTWVkaWE6IGFkZE1lZGlhLFxuXHRcdGZpbmRPckNyZWF0ZTogZnVuY3Rpb24obWVkaWFUaXRsZSkge1xuXHRcdFx0dmFyIHNlbGYgPSB0aGlzO1xuXHRcdFx0Y29uc29sZS5sb2coJ2luIHRoZSBmaW5kT3JDcmVhdGUnKVxuXHRcdFx0cmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuXHRcdFx0XHRpZiAoc2VsZi5sb2FkZWQgJiYgc2VsZi5kYi5nZXRDb2xsZWN0aW9uKCdtZWRpYScpKSB7XG5cdFx0XHRcdFx0ZmluZE9tZGIobWVkaWFUaXRsZSlcblx0XHRcdFx0XHRcdC50aGVuKGZ1bmN0aW9uKG1ldGFkYXRhKSB7XG5cdFx0XHRcdFx0XHRcdGlmIChzZWxmLmNvbGxlY3Rpb24uZmluZCh7XG5cdFx0XHRcdFx0XHRcdFx0XHQnX2lkJzogbWV0YWRhdGEuaW1kYi5pZFxuXHRcdFx0XHRcdFx0XHRcdH0pLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhzZWxmLmNvbGxlY3Rpb24uZmluZCh7XG5cdFx0XHRcdFx0XHRcdFx0XHQndGl0bGUnOiBtZWRpYVRpdGxlXG5cdFx0XHRcdFx0XHRcdFx0fSkubGVuZ3RoKTtcblx0XHRcdFx0XHRcdFx0XHQvL1N0aWxsIG5lZWQgdG8gcmV0dXJuIGFjdHVhbCBmaWxlXG5cdFx0XHRcdFx0XHRcdFx0cmV0dXJuIHJlc29sdmUobnVsbCk7XG5cdFx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdFx0Y29uc29sZS5sb2coJ2NyZWF0aW5nJyk7XG5cdFx0XHRcdFx0XHRcdFx0dmFyIG1lZGlhID0ge307XG5cdFx0XHRcdFx0XHRcdFx0bWVkaWEgPSBtZXRhZGF0YTtcblx0XHRcdFx0XHRcdFx0XHRtZWRpYS5faWQgPSBtZXRhZGF0YS5pbWRiLmlkO1xuXHRcdFx0XHRcdFx0XHRcdHNlbGYuY29sbGVjdGlvbi5pbnNlcnQobWVkaWEpO1xuXHRcdFx0XHRcdFx0XHRcdGNvbnNvbGUubG9nKG1lZGlhKTtcblx0XHRcdFx0XHRcdFx0XHRzZWxmLmRiLnNhdmVEYXRhYmFzZSgpO1xuXHRcdFx0XHRcdFx0XHRcdHJlc29sdmUoc2VsZik7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH0pXG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0cmVqZWN0KG5ldyBFcnJvcignZGIgaXMgbm90IHJlYWR5JykpO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblx0XHR9XG5cdH07XG59KTtcbiIsImFuZ0FwcC5jb250cm9sbGVyKCdTaWRlYmFyQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSkge1xuXG4gIC8vTGVmdG92ZXIgYXR0ZW1wdHMgdG8gbWFrZSBzaWRlYmFyIHRvZ2dsZWFibGVcbiAgLy8gJHNjb3BlLm1lbnVBY3RpdmUgPSBmYWxzZTtcbiAgLy8gdmFyIHdyYXBwZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2lkZWJhci13cmFwcGVyJylcbiAgLy8gJHNjb3BlLnRvZ2dsZU1lbnUgPSBmdW5jdGlvbihlKSB7XG4gIC8vICAgLy8gd3JhcHBlci50b2dnbGVDbGFzcyhcInRvZ2dsZWRcIik7XG4gIC8vICAgJHNjb3BlLm1lbnVBY3RpdmUgPSAhJHNjb3BlLm1lbnVBY3RpdmU7XG4gIC8vfVxuXG4gIC8vcGxhY2Vob2xkZXIgZm9yIG1ha2luZyBuZXcgcGxheWxpc3RzXG5cblxufSlcbiIsImFuZ0FwcC5kaXJlY3RpdmUoJ3NpZGViYXInLCBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHtcbiAgICByZXN0cmljdDogJ0UnLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9hcHAvanMvZGlyZWN0aXZlcy9zaWRlYmFyL3NpZGViYXIuaHRtbCdcbiAgfTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
