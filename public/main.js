'use strict';

var angApp = angular.module('main', ['ui.router']);

angApp.config(function ($urlRouterProvider) {
		$urlRouterProvider.otherwise('/');
});

angApp.controller('DashboardCtrl', function ($rootScope, $scope, Storage, initialize) {});

angApp.config(function ($stateProvider) {
		$stateProvider.state('dashboardState', {
				url: '/dashboard',
				templateUrl: './app/js/common/dashboard/dashboard.html',
				controller: 'DashboardCtrl'
		});
});

angApp.controller('ExplorerCtrl', function ($scope, $element, vidConstants, Storage, initialize, $rootScope) {
		// Code to make the 'file holder div' take in
		// file path names

		// $rootScope.$on('dbLoaded', function() {
		//   console.log('initialized', Storage.findOrCreate(soln.name).then(result=> console.log(result)));
		//   // .then(function(result) {console.log(result)});
		// })

		var homedir = process.platform === 'win32' ? process.env.HOMEPATH : process.env.HOME;
		var shell = require('electron').shell;
		// var finder = require('./server/algorithms/search.js')
		var fs = require('fs');
		var path = require('path');
		var find = require('findit');
		var parseVideo = require('video-name-parser');

		//Button called "browse", opens homedirectory of user
		$scope.openHome = function () {
				return shell.showItemInFolder(homedir);
		};

		// --------------------------
		// Code that allows you to recurse through the directories
		//provided and return file names that end with certain exts

		var holder = document.getElementById('fileholder');
		holder.ondragover = function () {
				this.className = 'hover';
				return false;
		};
		holder.ondragleave = function () {
				this.className = '';
				return false;
		};
		holder.ondrop = function (e) {
				var dataPathArray = [];
				var soln = [];
				e.preventDefault();
				for (var i = 0; i < e.dataTransfer.files.length; ++i) {
						dataPathArray.push(e.dataTransfer.files[i].path);
				}
				dataPathArray.forEach(function (data) {
						var finder = find(data);
						finder.on('file', function (file, stat) {
								var mediaName = file.split("/").pop();
								console.log(mediaName);
								if (vidConstants.vidExtensions.indexOf(path.extname(file)) !== -1) {
										var parsed = parseVideo(mediaName);
										parsed.filePath = file;
										soln.push(parsed);
								}
								console.log("Thank you for your patience!");
						});
						finder.on('end', function (file, stat) {

								soln.forEach(function (eachFile) {
										var mediaObj = { title: eachFile.name, year: eachFile.year, season: eachFile.season, episode: eachFile.episode };
										Storage.findOrCreate(mediaObj).then(function (result) {
												return console.log(result);
										});
								});
								console.log('soln', soln);
						});
				});
				return false;
		};
});

angApp.factory('vidConstants', function () {
		return {
				vidExtensions: ['.mkv', '.avi', '.mov', '.gifv', '.flv']
		};
});

angApp.config(function ($stateProvider) {
		$stateProvider.state('explorerState', {
				url: '/',
				templateUrl: './app/js/common/explorer/explorer.html',
				controller: 'ExplorerCtrl',
				resolve: {
						initialize: function initialize(Storage) {
								return Storage.init();
						}
				}
		});
});

'use strict';
var loki = require('lokijs'),
    path = require('path'),
    Promise = require('bluebird'),
    omdb = Promise.promisifyAll(require('omdb'));

angApp.factory('Storage', function ($rootScope) {
		function findOmdb(name) {
				console.log('in omdb function', name);
				return omdb.searchAsync(name).then(function (results) {
						if (results.length < 1) return;
						if (results.length >= 1) {
								return omdb.getAsync(results[0].imdb);
						}
				});
		};
		//Not being used anymore
		function addMedia(mediaTitle) {
				var self = this;
				console.log(self);
				return new Promise(function (resolve, reject) {
						console.log(self);
						findOmdb(mediaTitle).then(function (metadata) {
								var media = {};
								media = metadata;
								media._id = metadata.imdb.id;
								self.collection.insert(media);
								console.log(media);
								self.db.saveDatabase();
						}).then(function () {
								resolve(self);
						}, function (err) {
								reject(err);
						});
				});
		};

		return {
				db: new loki(path.resolve(__dirname, 'app.db')),
				collection: null,
				loaded: false,
				init: function init() {
						var self = this;
						self.db.loadDatabase({}, function () {
								return new Promise(function (resolve, reject) {
										if (self.db.collections.length) {
												self.collection = self.db.getCollection('media');
												self.loaded = true;
												return resolve(self);
										} else {
												self.db.addCollection('media');
												self.db.saveDatabase();
												self.collection = self.db.getCollection('media');
												self.loaded = true;
												return resolve(self);
										}
								}).then(function () {
										console.log('in the factory', self);
										$rootScope.$emit('dbLoaded');
								}).then(null, function (err) {
										console.log(err);
								});
								// .catch(function(err) {
								// 	console.log(err);
								// })
						});
				},
				findMedia: function findMedia(mediaId) {
						var self = this;
						return new Promise(function (resolve, reject) {
								if (self.loaded && self.db.getCollection('media')) {
										return resolve(self.collection.find({
												"_id": mediaId
										}));
								} else {
										reject(new Error('db is not ready'));
								}
						});
				},
				//not being used either
				addMedia: addMedia,
				findOrCreate: function findOrCreate(mediaTitle) {
						var self = this;
						console.log('in the findOrCreate');
						return new Promise(function (resolve, reject) {
								if (self.loaded && self.db.getCollection('media')) {
										findOmdb(mediaTitle).then(function (metadata) {
												if (self.collection.find({
														'_id': metadata.imdb.id
												}).length > 0) {
														console.log(self.collection.find({
																'title': mediaTitle
														}).length);
														//Still need to return actual file
														return resolve(null);
												} else {
														console.log('creating');
														var media = {};
														media = metadata;
														media._id = metadata.imdb.id;
														self.collection.insert(media);
														console.log(media);
														self.db.saveDatabase();
														resolve(self);
												}
										});
								} else {
										reject(new Error('db is not ready'));
								}
						});
				}
		};
});

angApp.controller('PlayerCtrl', function ($rootScope, $scope) {
		console.log('hitting the player controller');
});

angApp.config(function ($stateProvider) {
		$stateProvider.state('playerState', {
				url: '/player',
				templateUrl: './app/js/common/player/player.html',
				controller: 'PlayerCtrl'
		});
});

angApp.controller('SingleItemCtrl', function ($rootScope, $scope) {
		console.log('hitting the single item controller');
});

angApp.config(function ($stateProvider) {
		$stateProvider.state('singleItemState', {
				url: '/singleItem',
				templateUrl: './app/js/common/singleItem/singleItem.html',
				controller: 'singleItemCtrl'
		});
});

angApp.controller('SidebarCtrl', function ($scope) {

		//Leftover attempts to make sidebar toggleable
		// $scope.menuActive = false;
		// var wrapper = document.getElementById('sidebar-wrapper')
		// $scope.toggleMenu = function(e) {
		//   // wrapper.toggleClass("toggled");
		//   $scope.menuActive = !$scope.menuActive;
		//}

		//placeholder for making new playlists

});

angApp.directive('sidebar', function () {
		return {
				restrict: 'E',
				templateUrl: './app/js/directives/sidebar/sidebar.html'
		};
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImpzL2NvbW1vbi9kYXNoYm9hcmQvZGFzaGJvYXJkLmNvbnRyb2xsZXIuanMiLCJqcy9jb21tb24vZGFzaGJvYXJkL2Rhc2hib2FyZC5zdGF0ZS5qcyIsImpzL2NvbW1vbi9leHBsb3Jlci9leHBsb3Jlci5jb250cm9sbGVyLmpzIiwianMvY29tbW9uL2V4cGxvcmVyL2V4cGxvcmVyLnN0YXRlLmpzIiwianMvY29tbW9uL2ZhY3Rvcmllcy9DYWNoZUZhY3RvcnkuanMiLCJqcy9jb21tb24vcGxheWVyL3BsYXllci5jb250cm9sbGVyLmpzIiwianMvY29tbW9uL3BsYXllci9wbGF5ZXIuc3RhdGUuanMiLCJqcy9jb21tb24vc2luZ2xlSXRlbS9zaW5nbGVJdGVtLmNvbnRyb2xsZXIuanMiLCJqcy9jb21tb24vc2luZ2xlSXRlbS9zaW5nbGVJdGVtLnN0YXRlLmpzIiwianMvY29tbW9uL2RpcmVjdGl2ZXMvc2lkZWJhci9zaWRlYmFyLmNvbnRyb2xsZXIuanMiLCJqcy9jb21tb24vZGlyZWN0aXZlcy9zaWRlYmFyL3NpZGViYXIuZGlyZWN0aXZlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBQSxNQUFBLEdBQUEsT0FBQSxDQUFBLE1BQUEsQ0FBQSxNQUFBLEVBQUEsQ0FBQSxXQUFBLENBQUEsQ0FBQSxDQUFBOztBQUVBLE1BQUEsQ0FBQSxNQUFBLENBQUEsVUFBQSxrQkFBQSxFQUFBO0FBQ0Esb0JBQUEsQ0FBQSxTQUFBLENBQUEsR0FBQSxDQUFBLENBQUE7Q0FDQSxDQUFBLENBQUE7O0FDSkEsTUFBQSxDQUFBLFVBQUEsQ0FBQSxlQUFBLEVBQUEsVUFBQSxVQUFBLEVBQUEsTUFBQSxFQUFBLE9BQUEsRUFBQSxVQUFBLEVBQUEsRUFDQSxDQUFBLENBQUE7O0FDREEsTUFBQSxDQUFBLE1BQUEsQ0FBQSxVQUFBLGNBQUEsRUFBQTtBQUNBLGdCQUFBLENBQUEsS0FBQSxDQUFBLGdCQUFBLEVBQUE7QUFDQSxPQUFBLEVBQUEsWUFBQTtBQUNBLGVBQUEsRUFBQSwwQ0FBQTtBQUNBLGNBQUEsRUFBQSxlQUFBO0dBQ0EsQ0FBQSxDQUFBO0NBQ0EsQ0FBQSxDQUFBOztBQ05BLE1BQUEsQ0FBQSxVQUFBLENBQUEsY0FBQSxFQUFBLFVBQUEsTUFBQSxFQUFBLFFBQUEsRUFBQSxZQUFBLEVBQUEsT0FBQSxFQUFBLFVBQUEsRUFBQSxVQUFBLEVBQUE7Ozs7Ozs7OztBQVNBLE1BQUEsT0FBQSxHQUFBLE9BQUEsQ0FBQSxRQUFBLEtBQUEsT0FBQSxHQUFBLE9BQUEsQ0FBQSxHQUFBLENBQUEsUUFBQSxHQUNBLE9BQUEsQ0FBQSxHQUFBLENBQUEsSUFBQSxDQUFBO0FBQ0EsTUFBQSxLQUFBLEdBQUEsT0FBQSxDQUFBLFVBQUEsQ0FBQSxDQUFBLEtBQUEsQ0FBQTs7QUFFQSxNQUFBLEVBQUEsR0FBQSxPQUFBLENBQUEsSUFBQSxDQUFBLENBQUE7QUFDQSxNQUFBLElBQUEsR0FBQSxPQUFBLENBQUEsTUFBQSxDQUFBLENBQUE7QUFDQSxNQUFBLElBQUEsR0FBQSxPQUFBLENBQUEsUUFBQSxDQUFBLENBQUE7QUFDQSxNQUFBLFVBQUEsR0FBQSxPQUFBLENBQUEsbUJBQUEsQ0FBQSxDQUFBOzs7QUFHQSxRQUFBLENBQUEsUUFBQSxHQUFBLFlBQUE7QUFDQSxXQUFBLEtBQUEsQ0FBQSxnQkFBQSxDQUFBLE9BQUEsQ0FBQSxDQUFBO0dBQ0EsQ0FBQTs7Ozs7O0FBTUEsTUFBQSxNQUFBLEdBQUEsUUFBQSxDQUFBLGNBQUEsQ0FBQSxZQUFBLENBQUEsQ0FBQTtBQUNBLFFBQUEsQ0FBQSxVQUFBLEdBQUEsWUFBQTtBQUNBLFFBQUEsQ0FBQSxTQUFBLEdBQUEsT0FBQSxDQUFBO0FBQ0EsV0FBQSxLQUFBLENBQUE7R0FDQSxDQUFBO0FBQ0EsUUFBQSxDQUFBLFdBQUEsR0FBQSxZQUFBO0FBQ0EsUUFBQSxDQUFBLFNBQUEsR0FBQSxFQUFBLENBQUE7QUFDQSxXQUFBLEtBQUEsQ0FBQTtHQUNBLENBQUE7QUFDQSxRQUFBLENBQUEsTUFBQSxHQUFBLFVBQUEsQ0FBQSxFQUFBO0FBQ0EsUUFBQSxhQUFBLEdBQUEsRUFBQSxDQUFBO0FBQ0EsUUFBQSxJQUFBLEdBQUEsRUFBQSxDQUFBO0FBQ0EsS0FBQSxDQUFBLGNBQUEsRUFBQSxDQUFBO0FBQ0EsU0FBQSxJQUFBLENBQUEsR0FBQSxDQUFBLEVBQUEsQ0FBQSxHQUFBLENBQUEsQ0FBQSxZQUFBLENBQUEsS0FBQSxDQUFBLE1BQUEsRUFBQSxFQUFBLENBQUEsRUFBQTtBQUNBLG1CQUFBLENBQUEsSUFBQSxDQUFBLENBQUEsQ0FBQSxZQUFBLENBQUEsS0FBQSxDQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBO0tBQ0E7QUFDQSxpQkFBQSxDQUFBLE9BQUEsQ0FBQSxVQUFBLElBQUEsRUFBQTtBQUNBLFVBQUEsTUFBQSxHQUFBLElBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQTtBQUNBLFlBQUEsQ0FBQSxFQUFBLENBQUEsTUFBQSxFQUFBLFVBQUEsSUFBQSxFQUFBLElBQUEsRUFBQTtBQUNBLFlBQUEsU0FBQSxHQUFBLElBQUEsQ0FBQSxLQUFBLENBQUEsR0FBQSxDQUFBLENBQUEsR0FBQSxFQUFBLENBQUE7QUFDQSxlQUFBLENBQUEsR0FBQSxDQUFBLFNBQUEsQ0FBQSxDQUFBO0FBQ0EsWUFBQSxZQUFBLENBQUEsYUFBQSxDQUFBLE9BQUEsQ0FBQSxJQUFBLENBQUEsT0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBLEtBQ0EsQ0FBQSxDQUFBLEVBQUE7QUFDQSxjQUFBLE1BQUEsR0FBQSxVQUFBLENBQUEsU0FBQSxDQUFBLENBQUE7QUFDQSxnQkFBQSxDQUFBLFFBQUEsR0FBQSxJQUFBLENBQUE7QUFDQSxjQUFBLENBQUEsSUFBQSxDQUFBLE1BQUEsQ0FBQSxDQUFBO1NBQ0E7QUFDQSxlQUFBLENBQUEsR0FBQSxDQUFBLDhCQUFBLENBQUEsQ0FBQTtPQUNBLENBQUEsQ0FBQTtBQUNBLFlBQUEsQ0FBQSxFQUFBLENBQUEsS0FBQSxFQUFBLFVBQUEsSUFBQSxFQUFBLElBQUEsRUFBQTs7QUFFQSxZQUFBLENBQUEsT0FBQSxDQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsY0FBQSxRQUFBLEdBQUEsRUFBQSxLQUFBLEVBQUEsUUFBQSxDQUFBLElBQUEsRUFBQSxJQUFBLEVBQUEsUUFBQSxDQUFBLElBQUEsRUFBQSxNQUFBLEVBQUEsUUFBQSxDQUFBLE1BQUEsRUFBQSxPQUFBLEVBQUEsUUFBQSxDQUFBLE9BQUEsRUFBQSxDQUFBO0FBQ0EsaUJBQUEsQ0FBQSxZQUFBLENBQUEsUUFBQSxDQUFBLENBQUEsSUFBQSxDQUFBLFVBQUEsTUFBQTttQkFBQSxPQUFBLENBQUEsR0FBQSxDQUFBLE1BQUEsQ0FBQTtXQUFBLENBQUEsQ0FBQTtTQUNBLENBQUEsQ0FBQTtBQUNBLGVBQUEsQ0FBQSxHQUFBLENBQUEsTUFBQSxFQUFBLElBQUEsQ0FBQSxDQUFBO09BQ0EsQ0FBQSxDQUFBO0tBQ0EsQ0FBQSxDQUFBO0FBQ0EsV0FBQSxLQUFBLENBQUE7R0FDQSxDQUFBO0NBQ0EsQ0FBQSxDQUFBOztBQUdBLE1BQUEsQ0FBQSxPQUFBLENBQUEsY0FBQSxFQUFBLFlBQUE7QUFDQSxTQUFBO0FBQ0EsaUJBQUEsRUFBQSxDQUFBLE1BQUEsRUFBQSxNQUFBLEVBQUEsTUFBQSxFQUFBLE9BQUEsRUFBQSxNQUFBLENBQUE7R0FDQSxDQUFBO0NBQ0EsQ0FBQSxDQUFBOztBQzFFQSxNQUFBLENBQUEsTUFBQSxDQUFBLFVBQUEsY0FBQSxFQUFBO0FBQ0EsZ0JBQUEsQ0FBQSxLQUFBLENBQUEsZUFBQSxFQUFBO0FBQ0EsT0FBQSxFQUFBLEdBQUE7QUFDQSxlQUFBLEVBQUEsd0NBQUE7QUFDQSxjQUFBLEVBQUEsY0FBQTtBQUNBLFdBQUEsRUFBQTtBQUNBLGdCQUFBLEVBQUEsb0JBQUEsT0FBQSxFQUFBO0FBQ0EsZUFBQSxPQUFBLENBQUEsSUFBQSxFQUFBLENBQUE7T0FDQTtLQUNBO0dBQ0EsQ0FBQSxDQUFBO0NBQ0EsQ0FBQSxDQUFBOztBQ1hBLFlBQUEsQ0FBQTtBQUNBLElBQUEsSUFBQSxHQUFBLE9BQUEsQ0FBQSxRQUFBLENBQUE7SUFDQSxJQUFBLEdBQUEsT0FBQSxDQUFBLE1BQUEsQ0FBQTtJQUNBLE9BQUEsR0FBQSxPQUFBLENBQUEsVUFBQSxDQUFBO0lBQ0EsSUFBQSxHQUFBLE9BQUEsQ0FBQSxZQUFBLENBQUEsT0FBQSxDQUFBLE1BQUEsQ0FBQSxDQUFBLENBQUE7O0FBR0EsTUFBQSxDQUFBLE9BQUEsQ0FBQSxTQUFBLEVBQUEsVUFBQSxVQUFBLEVBQUE7QUFDQSxXQUFBLFFBQUEsQ0FBQSxJQUFBLEVBQUE7QUFDQSxXQUFBLENBQUEsR0FBQSxDQUFBLGtCQUFBLEVBQUEsSUFBQSxDQUFBLENBQUE7QUFDQSxXQUFBLElBQUEsQ0FBQSxXQUFBLENBQUEsSUFBQSxDQUFBLENBQ0EsSUFBQSxDQUFBLFVBQUEsT0FBQSxFQUFBO0FBQ0EsVUFBQSxPQUFBLENBQUEsTUFBQSxHQUFBLENBQUEsRUFBQSxPQUFBO0FBQ0EsVUFBQSxPQUFBLENBQUEsTUFBQSxJQUFBLENBQUEsRUFBQTtBQUNBLGVBQUEsSUFBQSxDQUFBLFFBQUEsQ0FBQSxPQUFBLENBQUEsQ0FBQSxDQUFBLENBQUEsSUFBQSxDQUFBLENBQUE7T0FDQTtLQUNBLENBQUEsQ0FBQTtHQUNBLENBQUE7O0FBRUEsV0FBQSxRQUFBLENBQUEsVUFBQSxFQUFBO0FBQ0EsUUFBQSxJQUFBLEdBQUEsSUFBQSxDQUFBO0FBQ0EsV0FBQSxDQUFBLEdBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQTtBQUNBLFdBQUEsSUFBQSxPQUFBLENBQUEsVUFBQSxPQUFBLEVBQUEsTUFBQSxFQUFBO0FBQ0EsYUFBQSxDQUFBLEdBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQTtBQUNBLGNBQUEsQ0FBQSxVQUFBLENBQUEsQ0FDQSxJQUFBLENBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxZQUFBLEtBQUEsR0FBQSxFQUFBLENBQUE7QUFDQSxhQUFBLEdBQUEsUUFBQSxDQUFBO0FBQ0EsYUFBQSxDQUFBLEdBQUEsR0FBQSxRQUFBLENBQUEsSUFBQSxDQUFBLEVBQUEsQ0FBQTtBQUNBLFlBQUEsQ0FBQSxVQUFBLENBQUEsTUFBQSxDQUFBLEtBQUEsQ0FBQSxDQUFBO0FBQ0EsZUFBQSxDQUFBLEdBQUEsQ0FBQSxLQUFBLENBQUEsQ0FBQTtBQUNBLFlBQUEsQ0FBQSxFQUFBLENBQUEsWUFBQSxFQUFBLENBQUE7T0FDQSxDQUFBLENBQ0EsSUFBQSxDQUFBLFlBQUE7QUFDQSxlQUFBLENBQUEsSUFBQSxDQUFBLENBQUE7T0FDQSxFQUFBLFVBQUEsR0FBQSxFQUFBO0FBQ0EsY0FBQSxDQUFBLEdBQUEsQ0FBQSxDQUFBO09BQ0EsQ0FBQSxDQUFBO0tBQ0EsQ0FBQSxDQUFBO0dBQ0EsQ0FBQTs7QUFFQSxTQUFBO0FBQ0EsTUFBQSxFQUFBLElBQUEsSUFBQSxDQUFBLElBQUEsQ0FBQSxPQUFBLENBQUEsU0FBQSxFQUFBLFFBQUEsQ0FBQSxDQUFBO0FBQ0EsY0FBQSxFQUFBLElBQUE7QUFDQSxVQUFBLEVBQUEsS0FBQTtBQUNBLFFBQUEsRUFBQSxnQkFBQTtBQUNBLFVBQUEsSUFBQSxHQUFBLElBQUEsQ0FBQTtBQUNBLFVBQUEsQ0FBQSxFQUFBLENBQUEsWUFBQSxDQUFBLEVBQUEsRUFBQSxZQUFBO0FBQ0EsZUFBQSxJQUFBLE9BQUEsQ0FBQSxVQUFBLE9BQUEsRUFBQSxNQUFBLEVBQUE7QUFDQSxjQUFBLElBQUEsQ0FBQSxFQUFBLENBQUEsV0FBQSxDQUFBLE1BQUEsRUFBQTtBQUNBLGdCQUFBLENBQUEsVUFBQSxHQUFBLElBQUEsQ0FBQSxFQUFBLENBQUEsYUFBQSxDQUFBLE9BQUEsQ0FBQSxDQUFBO0FBQ0EsZ0JBQUEsQ0FBQSxNQUFBLEdBQUEsSUFBQSxDQUFBO0FBQ0EsbUJBQUEsT0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBO1dBQ0EsTUFBQTtBQUNBLGdCQUFBLENBQUEsRUFBQSxDQUFBLGFBQUEsQ0FBQSxPQUFBLENBQUEsQ0FBQTtBQUNBLGdCQUFBLENBQUEsRUFBQSxDQUFBLFlBQUEsRUFBQSxDQUFBO0FBQ0EsZ0JBQUEsQ0FBQSxVQUFBLEdBQUEsSUFBQSxDQUFBLEVBQUEsQ0FBQSxhQUFBLENBQUEsT0FBQSxDQUFBLENBQUE7QUFDQSxnQkFBQSxDQUFBLE1BQUEsR0FBQSxJQUFBLENBQUE7QUFDQSxtQkFBQSxPQUFBLENBQUEsSUFBQSxDQUFBLENBQUE7V0FDQTtTQUNBLENBQUEsQ0FDQSxJQUFBLENBQUEsWUFBQTtBQUNBLGlCQUFBLENBQUEsR0FBQSxDQUFBLGdCQUFBLEVBQUEsSUFBQSxDQUFBLENBQUE7QUFDQSxvQkFBQSxDQUFBLEtBQUEsQ0FBQSxVQUFBLENBQUEsQ0FBQTtTQUNBLENBQUEsQ0FDQSxJQUFBLENBQUEsSUFBQSxFQUFBLFVBQUEsR0FBQSxFQUFBO0FBQ0EsaUJBQUEsQ0FBQSxHQUFBLENBQUEsR0FBQSxDQUFBLENBQUE7U0FDQSxDQUFBLENBQUE7Ozs7T0FJQSxDQUFBLENBQUE7S0FDQTtBQUNBLGFBQUEsRUFBQSxtQkFBQSxPQUFBLEVBQUE7QUFDQSxVQUFBLElBQUEsR0FBQSxJQUFBLENBQUE7QUFDQSxhQUFBLElBQUEsT0FBQSxDQUFBLFVBQUEsT0FBQSxFQUFBLE1BQUEsRUFBQTtBQUNBLFlBQUEsSUFBQSxDQUFBLE1BQUEsSUFBQSxJQUFBLENBQUEsRUFBQSxDQUFBLGFBQUEsQ0FBQSxPQUFBLENBQUEsRUFBQTtBQUNBLGlCQUFBLE9BQUEsQ0FBQSxJQUFBLENBQUEsVUFBQSxDQUFBLElBQUEsQ0FBQTtBQUNBLGlCQUFBLEVBQUEsT0FBQTtXQUNBLENBQUEsQ0FBQSxDQUFBO1NBQ0EsTUFBQTtBQUNBLGdCQUFBLENBQUEsSUFBQSxLQUFBLENBQUEsaUJBQUEsQ0FBQSxDQUFBLENBQUE7U0FDQTtPQUNBLENBQUEsQ0FBQTtLQUNBOztBQUVBLFlBQUEsRUFBQSxRQUFBO0FBQ0EsZ0JBQUEsRUFBQSxzQkFBQSxVQUFBLEVBQUE7QUFDQSxVQUFBLElBQUEsR0FBQSxJQUFBLENBQUE7QUFDQSxhQUFBLENBQUEsR0FBQSxDQUFBLHFCQUFBLENBQUEsQ0FBQTtBQUNBLGFBQUEsSUFBQSxPQUFBLENBQUEsVUFBQSxPQUFBLEVBQUEsTUFBQSxFQUFBO0FBQ0EsWUFBQSxJQUFBLENBQUEsTUFBQSxJQUFBLElBQUEsQ0FBQSxFQUFBLENBQUEsYUFBQSxDQUFBLE9BQUEsQ0FBQSxFQUFBO0FBQ0Esa0JBQUEsQ0FBQSxVQUFBLENBQUEsQ0FDQSxJQUFBLENBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxnQkFBQSxJQUFBLENBQUEsVUFBQSxDQUFBLElBQUEsQ0FBQTtBQUNBLG1CQUFBLEVBQUEsUUFBQSxDQUFBLElBQUEsQ0FBQSxFQUFBO2FBQ0EsQ0FBQSxDQUFBLE1BQUEsR0FBQSxDQUFBLEVBQUE7QUFDQSxxQkFBQSxDQUFBLEdBQUEsQ0FBQSxJQUFBLENBQUEsVUFBQSxDQUFBLElBQUEsQ0FBQTtBQUNBLHVCQUFBLEVBQUEsVUFBQTtlQUNBLENBQUEsQ0FBQSxNQUFBLENBQUEsQ0FBQTs7QUFFQSxxQkFBQSxPQUFBLENBQUEsSUFBQSxDQUFBLENBQUE7YUFDQSxNQUFBO0FBQ0EscUJBQUEsQ0FBQSxHQUFBLENBQUEsVUFBQSxDQUFBLENBQUE7QUFDQSxrQkFBQSxLQUFBLEdBQUEsRUFBQSxDQUFBO0FBQ0EsbUJBQUEsR0FBQSxRQUFBLENBQUE7QUFDQSxtQkFBQSxDQUFBLEdBQUEsR0FBQSxRQUFBLENBQUEsSUFBQSxDQUFBLEVBQUEsQ0FBQTtBQUNBLGtCQUFBLENBQUEsVUFBQSxDQUFBLE1BQUEsQ0FBQSxLQUFBLENBQUEsQ0FBQTtBQUNBLHFCQUFBLENBQUEsR0FBQSxDQUFBLEtBQUEsQ0FBQSxDQUFBO0FBQ0Esa0JBQUEsQ0FBQSxFQUFBLENBQUEsWUFBQSxFQUFBLENBQUE7QUFDQSxxQkFBQSxDQUFBLElBQUEsQ0FBQSxDQUFBO2FBQ0E7V0FDQSxDQUFBLENBQUE7U0FDQSxNQUFBO0FBQ0EsZ0JBQUEsQ0FBQSxJQUFBLEtBQUEsQ0FBQSxpQkFBQSxDQUFBLENBQUEsQ0FBQTtTQUNBO09BQ0EsQ0FBQSxDQUFBO0tBQ0E7R0FDQSxDQUFBO0NBQ0EsQ0FBQSxDQUFBOztBQ3ZIQSxNQUFBLENBQUEsVUFBQSxDQUFBLFlBQUEsRUFBQSxVQUFBLFVBQUEsRUFBQSxNQUFBLEVBQUE7QUFDQSxTQUFBLENBQUEsR0FBQSxDQUFBLCtCQUFBLENBQUEsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUNGQSxNQUFBLENBQUEsTUFBQSxDQUFBLFVBQUEsY0FBQSxFQUFBO0FBQ0EsZ0JBQUEsQ0FBQSxLQUFBLENBQUEsYUFBQSxFQUFBO0FBQ0EsT0FBQSxFQUFBLFNBQUE7QUFDQSxlQUFBLEVBQUEsb0NBQUE7QUFDQSxjQUFBLEVBQUEsWUFBQTtHQUNBLENBQUEsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUNOQSxNQUFBLENBQUEsVUFBQSxDQUFBLGdCQUFBLEVBQUEsVUFBQSxVQUFBLEVBQUEsTUFBQSxFQUFBO0FBQ0EsU0FBQSxDQUFBLEdBQUEsQ0FBQSxvQ0FBQSxDQUFBLENBQUE7Q0FDQSxDQUFBLENBQUE7O0FDRkEsTUFBQSxDQUFBLE1BQUEsQ0FBQSxVQUFBLGNBQUEsRUFBQTtBQUNBLGdCQUFBLENBQUEsS0FBQSxDQUFBLGlCQUFBLEVBQUE7QUFDQSxPQUFBLEVBQUEsYUFBQTtBQUNBLGVBQUEsRUFBQSw0Q0FBQTtBQUNBLGNBQUEsRUFBQSxnQkFBQTtHQUNBLENBQUEsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUNOQSxNQUFBLENBQUEsVUFBQSxDQUFBLGFBQUEsRUFBQSxVQUFBLE1BQUEsRUFBQTs7Ozs7Ozs7Ozs7O0NBYUEsQ0FBQSxDQUFBOztBQ2JBLE1BQUEsQ0FBQSxTQUFBLENBQUEsU0FBQSxFQUFBLFlBQUE7QUFDQSxTQUFBO0FBQ0EsWUFBQSxFQUFBLEdBQUE7QUFDQSxlQUFBLEVBQUEsMENBQUE7R0FDQSxDQUFBO0NBQ0EsQ0FBQSxDQUFBIiwiZmlsZSI6Im1haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgYW5nQXBwID0gYW5ndWxhci5tb2R1bGUoJ21haW4nLCBbJ3VpLnJvdXRlciddKTtcblxuYW5nQXBwLmNvbmZpZyhmdW5jdGlvbigkdXJsUm91dGVyUHJvdmlkZXIpIHtcbiAgJHVybFJvdXRlclByb3ZpZGVyLm90aGVyd2lzZSgnLycpO1xufSlcbiIsImFuZ0FwcC5jb250cm9sbGVyKCdEYXNoYm9hcmRDdHJsJywgZnVuY3Rpb24oJHJvb3RTY29wZSwgJHNjb3BlLCBTdG9yYWdlLCBpbml0aWFsaXplKXtcbn0pXG4iLCJhbmdBcHAuY29uZmlnKGZ1bmN0aW9uKCRzdGF0ZVByb3ZpZGVyKXtcbiAgJHN0YXRlUHJvdmlkZXIuc3RhdGUoJ2Rhc2hib2FyZFN0YXRlJywge1xuICAgIHVybDogJy9kYXNoYm9hcmQnLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9hcHAvanMvY29tbW9uL2Rhc2hib2FyZC9kYXNoYm9hcmQuaHRtbCcsXG4gICAgY29udHJvbGxlcjogJ0Rhc2hib2FyZEN0cmwnXG4gIH0pXG59KVxuIiwiYW5nQXBwLmNvbnRyb2xsZXIoJ0V4cGxvcmVyQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsIHZpZENvbnN0YW50cywgU3RvcmFnZSwgaW5pdGlhbGl6ZSwgJHJvb3RTY29wZSkge1xuICAvLyBDb2RlIHRvIG1ha2UgdGhlICdmaWxlIGhvbGRlciBkaXYnIHRha2UgaW5cbiAgLy8gZmlsZSBwYXRoIG5hbWVzXG5cbiAgLy8gJHJvb3RTY29wZS4kb24oJ2RiTG9hZGVkJywgZnVuY3Rpb24oKSB7XG4gIC8vICAgY29uc29sZS5sb2coJ2luaXRpYWxpemVkJywgU3RvcmFnZS5maW5kT3JDcmVhdGUoc29sbi5uYW1lKS50aGVuKHJlc3VsdD0+IGNvbnNvbGUubG9nKHJlc3VsdCkpKTtcbiAgLy8gICAvLyAudGhlbihmdW5jdGlvbihyZXN1bHQpIHtjb25zb2xlLmxvZyhyZXN1bHQpfSk7XG4gIC8vIH0pXG5cbiAgdmFyIGhvbWVkaXIgPSAocHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJykgPyBwcm9jZXNzLmVudi5IT01FUEFUSCA6XG4gICAgcHJvY2Vzcy5lbnYuSE9NRTtcbiAgY29uc3Qgc2hlbGwgPSByZXF1aXJlKCdlbGVjdHJvbicpLnNoZWxsO1xuICAvLyB2YXIgZmluZGVyID0gcmVxdWlyZSgnLi9zZXJ2ZXIvYWxnb3JpdGhtcy9zZWFyY2guanMnKVxuICB2YXIgZnMgPSByZXF1aXJlKCdmcycpO1xuICB2YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbiAgdmFyIGZpbmQgPSByZXF1aXJlKCdmaW5kaXQnKTtcbiAgdmFyIHBhcnNlVmlkZW8gPSByZXF1aXJlKCd2aWRlby1uYW1lLXBhcnNlcicpO1xuXG4gIC8vQnV0dG9uIGNhbGxlZCBcImJyb3dzZVwiLCBvcGVucyBob21lZGlyZWN0b3J5IG9mIHVzZXJcbiAgJHNjb3BlLm9wZW5Ib21lID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHNoZWxsLnNob3dJdGVtSW5Gb2xkZXIoaG9tZWRpcik7XG4gIH1cblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBDb2RlIHRoYXQgYWxsb3dzIHlvdSB0byByZWN1cnNlIHRocm91Z2ggdGhlIGRpcmVjdG9yaWVzXG4gIC8vcHJvdmlkZWQgYW5kIHJldHVybiBmaWxlIG5hbWVzIHRoYXQgZW5kIHdpdGggY2VydGFpbiBleHRzXG5cbiAgdmFyIGhvbGRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWxlaG9sZGVyJyk7XG4gIGhvbGRlci5vbmRyYWdvdmVyID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5jbGFzc05hbWUgPSAnaG92ZXInO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfTtcbiAgaG9sZGVyLm9uZHJhZ2xlYXZlID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5jbGFzc05hbWUgPSAnJztcbiAgICByZXR1cm4gZmFsc2U7XG4gIH07XG4gIGhvbGRlci5vbmRyb3AgPSBmdW5jdGlvbihlKSB7XG4gICAgdmFyIGRhdGFQYXRoQXJyYXkgPSBbXTtcbiAgICB2YXIgc29sbiA9IFtdO1xuICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGUuZGF0YVRyYW5zZmVyLmZpbGVzLmxlbmd0aDsgKytpKSB7XG4gICAgICBkYXRhUGF0aEFycmF5LnB1c2goZS5kYXRhVHJhbnNmZXIuZmlsZXNbaV0ucGF0aCk7XG4gICAgfVxuICAgIGRhdGFQYXRoQXJyYXkuZm9yRWFjaChmdW5jdGlvbihkYXRhKSB7XG4gICAgICB2YXIgZmluZGVyID0gZmluZChkYXRhKTtcbiAgICAgIGZpbmRlci5vbignZmlsZScsIGZ1bmN0aW9uKGZpbGUsIHN0YXQpIHtcbiAgICAgICAgdmFyIG1lZGlhTmFtZSA9IGZpbGUuc3BsaXQoXCIvXCIpLnBvcCgpXG4gICAgICAgIGNvbnNvbGUubG9nKG1lZGlhTmFtZSlcbiAgICAgICAgaWYgKHZpZENvbnN0YW50cy52aWRFeHRlbnNpb25zLmluZGV4T2YocGF0aC5leHRuYW1lKGZpbGUpKSAhPT1cbiAgICAgICAgICAtMSkge1xuICAgICAgICAgIHZhciBwYXJzZWQgPSBwYXJzZVZpZGVvKG1lZGlhTmFtZSk7XG4gICAgICAgICAgcGFyc2VkLmZpbGVQYXRoID0gZmlsZVxuICAgICAgICAgIHNvbG4ucHVzaChwYXJzZWQpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKFwiVGhhbmsgeW91IGZvciB5b3VyIHBhdGllbmNlIVwiKTtcbiAgICAgIH0pXG4gICAgICBmaW5kZXIub24oJ2VuZCcsIGZ1bmN0aW9uKGZpbGUsIHN0YXQpIHtcblxuICAgICAgICBzb2xuLmZvckVhY2goZnVuY3Rpb24oZWFjaEZpbGUpe1xuICAgICAgICAgIHZhciBtZWRpYU9iaiA9IHt0aXRsZTogZWFjaEZpbGUubmFtZSwgeWVhcjogZWFjaEZpbGUueWVhciwgc2Vhc29uOiBlYWNoRmlsZS5zZWFzb24sIGVwaXNvZGU6IGVhY2hGaWxlLmVwaXNvZGV9XG4gICAgICAgICAgU3RvcmFnZS5maW5kT3JDcmVhdGUobWVkaWFPYmopLnRoZW4ocmVzdWx0PT4gY29uc29sZS5sb2cocmVzdWx0KSlcbiAgICAgICAgfSlcbiAgICAgICAgY29uc29sZS5sb2coJ3NvbG4nLCBzb2xuKVxuICAgICAgfSlcbiAgICB9KVxuICAgIHJldHVybiBmYWxzZTtcbiAgfTtcbn0pO1xuXG5cbmFuZ0FwcC5mYWN0b3J5KCd2aWRDb25zdGFudHMnLCBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHtcbiAgICB2aWRFeHRlbnNpb25zOiBbJy5ta3YnLCAnLmF2aScsICcubW92JywgJy5naWZ2JywgJy5mbHYnXVxuICB9XG59KVxuIiwiYW5nQXBwLmNvbmZpZyhmdW5jdGlvbigkc3RhdGVQcm92aWRlcil7XG4gICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCdleHBsb3JlclN0YXRlJywge1xuICAgIHVybDogJy8nLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9hcHAvanMvY29tbW9uL2V4cGxvcmVyL2V4cGxvcmVyLmh0bWwnLFxuICAgIGNvbnRyb2xsZXI6ICdFeHBsb3JlckN0cmwnLFxuICAgIHJlc29sdmU6IHtcbiAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKFN0b3JhZ2UpIHtcbiAgICAgICAgcmV0dXJuIFN0b3JhZ2UuaW5pdCgpO1xuICAgICAgfVxuICAgIH1cbiAgfSlcbn0pXG4iLCIndXNlIHN0cmljdCc7XG52YXIgbG9raSA9IHJlcXVpcmUoJ2xva2lqcycpLFxuXHRwYXRoID0gcmVxdWlyZSgncGF0aCcpLFxuXHRQcm9taXNlID0gcmVxdWlyZSgnYmx1ZWJpcmQnKSxcblx0b21kYiA9IFByb21pc2UucHJvbWlzaWZ5QWxsKHJlcXVpcmUoJ29tZGInKSk7XG5cblxuYW5nQXBwLmZhY3RvcnkoJ1N0b3JhZ2UnLCBmdW5jdGlvbigkcm9vdFNjb3BlKSB7XG5cdGZ1bmN0aW9uIGZpbmRPbWRiKG5hbWUpIHtcblx0XHRjb25zb2xlLmxvZygnaW4gb21kYiBmdW5jdGlvbicsIG5hbWUpO1xuXHRcdHJldHVybiBvbWRiLnNlYXJjaEFzeW5jKG5hbWUpXG5cdFx0XHQudGhlbihmdW5jdGlvbihyZXN1bHRzKSB7XG5cdFx0XHRcdGlmIChyZXN1bHRzLmxlbmd0aCA8IDEpIHJldHVybjtcblx0XHRcdFx0aWYgKHJlc3VsdHMubGVuZ3RoID49IDEpIHtcblx0XHRcdFx0XHRyZXR1cm4gb21kYi5nZXRBc3luYyhyZXN1bHRzWzBdLmltZGIpO1xuXHRcdFx0XHR9XG5cdFx0XHR9KVxuXHR9O1xuXHQvL05vdCBiZWluZyB1c2VkIGFueW1vcmVcblx0ZnVuY3Rpb24gYWRkTWVkaWEobWVkaWFUaXRsZSkge1xuXHRcdHZhciBzZWxmID0gdGhpcztcblx0XHRjb25zb2xlLmxvZyhzZWxmKTtcblx0XHRyZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG5cdFx0XHRjb25zb2xlLmxvZyhzZWxmKTtcblx0XHRcdGZpbmRPbWRiKG1lZGlhVGl0bGUpXG5cdFx0XHRcdC50aGVuKGZ1bmN0aW9uKG1ldGFkYXRhKSB7XG5cdFx0XHRcdFx0dmFyIG1lZGlhID0ge307XG5cdFx0XHRcdFx0bWVkaWEgPSBtZXRhZGF0YTtcblx0XHRcdFx0XHRtZWRpYS5faWQgPSBtZXRhZGF0YS5pbWRiLmlkO1xuXHRcdFx0XHRcdHNlbGYuY29sbGVjdGlvbi5pbnNlcnQobWVkaWEpO1xuXHRcdFx0XHRcdGNvbnNvbGUubG9nKG1lZGlhKTtcblx0XHRcdFx0XHRzZWxmLmRiLnNhdmVEYXRhYmFzZSgpO1xuXHRcdFx0XHR9KVxuXHRcdFx0XHQudGhlbihmdW5jdGlvbigpIHtcblx0XHRcdFx0XHRyZXNvbHZlKHNlbGYpO1xuXHRcdFx0XHR9LCBmdW5jdGlvbihlcnIpIHtcblx0XHRcdFx0XHRyZWplY3QoZXJyKTtcblx0XHRcdFx0fSk7XG5cdFx0fSlcblx0fTtcblxuXHRyZXR1cm4ge1xuXHRcdGRiOiBuZXcgbG9raShwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnYXBwLmRiJykpLFxuXHRcdGNvbGxlY3Rpb246IG51bGwsXG5cdFx0bG9hZGVkOiBmYWxzZSxcblx0XHRpbml0OiBmdW5jdGlvbigpIHtcblx0XHRcdHZhciBzZWxmID0gdGhpcztcblx0XHRcdHNlbGYuZGIubG9hZERhdGFiYXNlKHt9LCBmdW5jdGlvbigpIHtcblx0XHRcdFx0cmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuXHRcdFx0XHRcdFx0aWYgKHNlbGYuZGIuY29sbGVjdGlvbnMubGVuZ3RoKSB7XG5cdFx0XHRcdFx0XHRcdHNlbGYuY29sbGVjdGlvbiA9IHNlbGYuZGIuZ2V0Q29sbGVjdGlvbignbWVkaWEnKTtcblx0XHRcdFx0XHRcdFx0c2VsZi5sb2FkZWQgPSB0cnVlO1xuXHRcdFx0XHRcdFx0XHRyZXR1cm4gcmVzb2x2ZShzZWxmKTtcblx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdHNlbGYuZGIuYWRkQ29sbGVjdGlvbignbWVkaWEnKTtcblx0XHRcdFx0XHRcdFx0c2VsZi5kYi5zYXZlRGF0YWJhc2UoKTtcblx0XHRcdFx0XHRcdFx0c2VsZi5jb2xsZWN0aW9uID0gc2VsZi5kYi5nZXRDb2xsZWN0aW9uKCdtZWRpYScpO1xuXHRcdFx0XHRcdFx0XHRzZWxmLmxvYWRlZCA9IHRydWU7XG5cdFx0XHRcdFx0XHRcdHJldHVybiByZXNvbHZlKHNlbGYpXG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fSlcblx0XHRcdFx0XHQudGhlbihmdW5jdGlvbigpIHtcblx0XHRcdFx0XHRcdGNvbnNvbGUubG9nKCdpbiB0aGUgZmFjdG9yeScsIHNlbGYpO1xuXHRcdFx0XHRcdFx0JHJvb3RTY29wZS4kZW1pdCgnZGJMb2FkZWQnKTtcblx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdC50aGVuKG51bGwsIGZ1bmN0aW9uKGVycikge1xuXHRcdFx0XHRcdFx0Y29uc29sZS5sb2coZXJyKVxuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0Ly8gLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuXHRcdFx0XHRcdC8vIFx0Y29uc29sZS5sb2coZXJyKTtcblx0XHRcdFx0XHQvLyB9KVxuXHRcdFx0fSlcblx0XHR9LFxuXHRcdGZpbmRNZWRpYTogZnVuY3Rpb24obWVkaWFJZCkge1xuXHRcdFx0dmFyIHNlbGYgPSB0aGlzO1xuXHRcdFx0cmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuXHRcdFx0XHRpZiAoc2VsZi5sb2FkZWQgJiYgc2VsZi5kYi5nZXRDb2xsZWN0aW9uKCdtZWRpYScpKSB7XG5cdFx0XHRcdFx0cmV0dXJuIHJlc29sdmUoc2VsZi5jb2xsZWN0aW9uLmZpbmQoe1xuXHRcdFx0XHRcdFx0XCJfaWRcIjogbWVkaWFJZFxuXHRcdFx0XHRcdH0pKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRyZWplY3QobmV3IEVycm9yKCdkYiBpcyBub3QgcmVhZHknKSk7XG5cdFx0XHRcdH1cblx0XHRcdH0pXG5cdFx0fSxcblx0XHQvL25vdCBiZWluZyB1c2VkIGVpdGhlclxuXHRcdGFkZE1lZGlhOiBhZGRNZWRpYSxcblx0XHRmaW5kT3JDcmVhdGU6IGZ1bmN0aW9uKG1lZGlhVGl0bGUpIHtcblx0XHRcdHZhciBzZWxmID0gdGhpcztcblx0XHRcdGNvbnNvbGUubG9nKCdpbiB0aGUgZmluZE9yQ3JlYXRlJylcblx0XHRcdHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcblx0XHRcdFx0aWYgKHNlbGYubG9hZGVkICYmIHNlbGYuZGIuZ2V0Q29sbGVjdGlvbignbWVkaWEnKSkge1xuXHRcdFx0XHRcdGZpbmRPbWRiKG1lZGlhVGl0bGUpXG5cdFx0XHRcdFx0XHQudGhlbihmdW5jdGlvbihtZXRhZGF0YSkge1xuXHRcdFx0XHRcdFx0XHRpZiAoc2VsZi5jb2xsZWN0aW9uLmZpbmQoe1xuXHRcdFx0XHRcdFx0XHRcdFx0J19pZCc6IG1ldGFkYXRhLmltZGIuaWRcblx0XHRcdFx0XHRcdFx0XHR9KS5sZW5ndGggPiAwKSB7XG5cdFx0XHRcdFx0XHRcdFx0Y29uc29sZS5sb2coc2VsZi5jb2xsZWN0aW9uLmZpbmQoe1xuXHRcdFx0XHRcdFx0XHRcdFx0J3RpdGxlJzogbWVkaWFUaXRsZVxuXHRcdFx0XHRcdFx0XHRcdH0pLmxlbmd0aCk7XG5cdFx0XHRcdFx0XHRcdFx0Ly9TdGlsbCBuZWVkIHRvIHJldHVybiBhY3R1YWwgZmlsZVxuXHRcdFx0XHRcdFx0XHRcdHJldHVybiByZXNvbHZlKG51bGwpO1xuXHRcdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRcdGNvbnNvbGUubG9nKCdjcmVhdGluZycpO1xuXHRcdFx0XHRcdFx0XHRcdHZhciBtZWRpYSA9IHt9O1xuXHRcdFx0XHRcdFx0XHRcdG1lZGlhID0gbWV0YWRhdGE7XG5cdFx0XHRcdFx0XHRcdFx0bWVkaWEuX2lkID0gbWV0YWRhdGEuaW1kYi5pZDtcblx0XHRcdFx0XHRcdFx0XHRzZWxmLmNvbGxlY3Rpb24uaW5zZXJ0KG1lZGlhKTtcblx0XHRcdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhtZWRpYSk7XG5cdFx0XHRcdFx0XHRcdFx0c2VsZi5kYi5zYXZlRGF0YWJhc2UoKTtcblx0XHRcdFx0XHRcdFx0XHRyZXNvbHZlKHNlbGYpO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHJlamVjdChuZXcgRXJyb3IoJ2RiIGlzIG5vdCByZWFkeScpKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0fVxuXHR9O1xufSk7XG4iLCJhbmdBcHAuY29udHJvbGxlcignUGxheWVyQ3RybCcsIGZ1bmN0aW9uKCRyb290U2NvcGUsICRzY29wZSl7XG4gIGNvbnNvbGUubG9nKCdoaXR0aW5nIHRoZSBwbGF5ZXIgY29udHJvbGxlcicpXG59KVxuIiwiYW5nQXBwLmNvbmZpZyhmdW5jdGlvbigkc3RhdGVQcm92aWRlcil7XG4gICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCdwbGF5ZXJTdGF0ZScsIHtcbiAgICB1cmw6ICcvcGxheWVyJyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vYXBwL2pzL2NvbW1vbi9wbGF5ZXIvcGxheWVyLmh0bWwnLFxuICAgIGNvbnRyb2xsZXI6ICdQbGF5ZXJDdHJsJ1xuICB9KVxufSlcbiIsImFuZ0FwcC5jb250cm9sbGVyKCdTaW5nbGVJdGVtQ3RybCcsIGZ1bmN0aW9uKCRyb290U2NvcGUsICRzY29wZSl7XG4gIGNvbnNvbGUubG9nKCdoaXR0aW5nIHRoZSBzaW5nbGUgaXRlbSBjb250cm9sbGVyJylcbn0pXG4iLCJhbmdBcHAuY29uZmlnKGZ1bmN0aW9uKCRzdGF0ZVByb3ZpZGVyKXtcbiAgJHN0YXRlUHJvdmlkZXIuc3RhdGUoJ3NpbmdsZUl0ZW1TdGF0ZScsIHtcbiAgICB1cmw6ICcvc2luZ2xlSXRlbScsXG4gICAgdGVtcGxhdGVVcmw6ICcuL2FwcC9qcy9jb21tb24vc2luZ2xlSXRlbS9zaW5nbGVJdGVtLmh0bWwnLFxuICAgIGNvbnRyb2xsZXI6ICdzaW5nbGVJdGVtQ3RybCdcbiAgfSlcbn0pXG4iLCJhbmdBcHAuY29udHJvbGxlcignU2lkZWJhckN0cmwnLCBmdW5jdGlvbigkc2NvcGUpIHtcblxuICAvL0xlZnRvdmVyIGF0dGVtcHRzIHRvIG1ha2Ugc2lkZWJhciB0b2dnbGVhYmxlXG4gIC8vICRzY29wZS5tZW51QWN0aXZlID0gZmFsc2U7XG4gIC8vIHZhciB3cmFwcGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NpZGViYXItd3JhcHBlcicpXG4gIC8vICRzY29wZS50b2dnbGVNZW51ID0gZnVuY3Rpb24oZSkge1xuICAvLyAgIC8vIHdyYXBwZXIudG9nZ2xlQ2xhc3MoXCJ0b2dnbGVkXCIpO1xuICAvLyAgICRzY29wZS5tZW51QWN0aXZlID0gISRzY29wZS5tZW51QWN0aXZlO1xuICAvL31cblxuICAvL3BsYWNlaG9sZGVyIGZvciBtYWtpbmcgbmV3IHBsYXlsaXN0c1xuXG5cbn0pXG4iLCJhbmdBcHAuZGlyZWN0aXZlKCdzaWRlYmFyJywgZnVuY3Rpb24oKSB7XG4gIHJldHVybiB7XG4gICAgcmVzdHJpY3Q6ICdFJyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vYXBwL2pzL2RpcmVjdGl2ZXMvc2lkZWJhci9zaWRlYmFyLmh0bWwnXG4gIH07XG59KTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
